<!DOCTYPE html>
<html>
<head>
    <title>流媒体管理后台</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .stream-list { 
            margin-top: 20px; 
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .stream-item { 
            border: 1px solid #ddd; 
            padding: 15px; 
            border-radius: 8px;
            background: #f9f9f9;
        }
        .stream-item.active {
            border-color: #4CAF50;
        }
        .stats {
            background: #fff;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .tabs {
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 4px;
        }
        .tab.active {
            background: #4CAF50;
            color: white;
        }
        textarea {
            width: 100%;
            height: 200px;
            margin-bottom: 10px;
            padding: 10px;
        }
        button {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        .error {
            color: red;
            margin-top: 10px;
        }
        .success {
            color: green;
            margin-top: 10px;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>流媒体管理后台</h1>
    
    <div class="tabs">
        <button class="tab active" onclick="showTab('single')">单个添加</button>
        <button class="tab" onclick="showTab('batch')">批量导入</button>
    </div>

    <div id="singleAdd" class="form-section">
        <h2>添加新流</h2>
        <form id="addStreamForm">
            <div>
                <label>ID: <input type="text" id="streamId" required></label>
            </div>
            <div>
                <label>名称: <input type="text" id="streamName" required></label>
            </div>
            <div>
                <label>URL: <input type="text" id="streamUrl" required></label>
            </div>
            <button type="submit">添加</button>
        </form>
    </div>

    <div id="batchAdd" class="form-section" style="display: none;">
        <h2>批量导入</h2>
        <p>请输入M3U格式的播放列表：</p>
        <textarea id="batchInput" placeholder="#EXTINF:-1 tvg-id='ID' tvg-name='名称',频道名称
http://example.com/stream"></textarea>
        <button onclick="importBatch()">导入</button>
        <div id="importResult"></div>
    </div>

    <h2>当前流列表</h2>
    <div class="stream-list" id="streamList"></div>

    <script>
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            
            document.getElementById('singleAdd').style.display = tabName === 'single' ? 'block' : 'none';
            document.getElementById('batchAdd').style.display = tabName === 'batch' ? 'block' : 'none';
        }

        async function loadStreams() {
            try {
                const response = await fetch('/api/streams');
                const streams = await response.json();
                const listEl = document.getElementById('streamList');
                listEl.innerHTML = streams.map(stream => `
                    <div class="stream-item ${stream.active ? 'active' : ''}">
                        <h3>${stream.name} (${stream.id})</h3>
                        <p>URL: ${stream.url}</p>
                        <p>状态: ${stream.active ? '活跃' : '停止'}</p>
                        <div class="stats">
                            <p>总请求数: ${stream.stats?.totalRequests || 0}</p>
                            <p>最后访问: ${stream.stats?.lastAccessed ? new Date(stream.stats.lastAccessed).toLocaleString() : '从未'}</p>
                            <p>错误次数: ${stream.stats?.errors || 0}</p>
                            <p>运行时间: ${formatUptime(stream.stats?.uptime || 0)}</p>
                        </div>
                        <div style="margin-top: 10px;">
                            ${stream.active ? 
                                `<button onclick="stopStream('${stream.id}')">停止</button>` : 
                                `<button onclick="startStream('${stream.id}')">启动</button>`}
                            <button onclick="deleteStream('${stream.id}')" style="background: #f44336;">删除</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading streams:', error);
            }
        }

        async function importBatch() {
            const input = document.getElementById('batchInput').value;
            const streams = parsem3u(input);
            const resultDiv = document.getElementById('importResult');
            
            try {
                for (const stream of streams) {
                    await fetch('/api/streams', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(stream)
                    });
                }
                resultDiv.innerHTML = `<div class="success">成功导入 ${streams.length} 个流</div>`;
                loadStreams();
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">导入失败: ${error.message}</div>`;
            }
        }

        function parsem3u(content) {
            const lines = content.split('\n');
            const streams = [];
            let currentStream = {};

            for (let line of lines) {
                line = line.trim();
                if (line.startsWith('#EXTINF:')) {
                    // 解析频道信息
                    const match = line.match(/tvg-id="([^"]*)".*tvg-name="([^"]*)".*,(.*)$/);
                    if (match) {
                        currentStream = {
                            id: match[1],
                            name: match[3] || match[2],
                        };
                    }
                } else if (line.startsWith('http')) {
                    // 添加URL并保存流
                    if (currentStream.id) {
                        currentStream.url = line;
                        streams.push({...currentStream});
                        currentStream = {};
                    }
                }
            }
            return streams;
        }

        async function stopStream(id) {
            try {
                await fetch(`/api/streams/${id}/stop`, { method: 'POST' });
                loadStreams();
            } catch (error) {
                console.error('Error stopping stream:', error);
            }
        }

        async function startStream(id) {
            try {
                await fetch(`/api/streams/${id}/start`, { method: 'POST' });
                loadStreams();
            } catch (error) {
                console.error('Error starting stream:', error);
            }
        }

        async function deleteStream(id) {
            if (!confirm('确定要删除这个流吗？')) return;
            try {
                await fetch(`/api/streams/${id}`, { method: 'DELETE' });
                loadStreams();
            } catch (error) {
                console.error('Error deleting stream:', error);
            }
        }

        document.getElementById('addStreamForm').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                id: document.getElementById('streamId').value,
                name: document.getElementById('streamName').value,
                url: document.getElementById('streamUrl').value
            };
            try {
                await fetch('/api/streams', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                loadStreams();
                e.target.reset();
            } catch (error) {
                console.error('Error adding stream:', error);
            }
        };

        function formatUptime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            return `${hours}小时${minutes % 60}分钟`;
        }

        // 初始加载
        loadStreams();
        // 定期刷新
        setInterval(loadStreams, 5000);
    </script>
</body>
</html> 