<!DOCTYPE html>
<html>
<head>
    <title>流媒体播放器</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            font-family: "Microsoft YaHei", Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 60px);
            margin-top: 60px;
        }

        .playlist-container {
            width: 300px;
            background: rgba(0, 0, 0, 0.9);
            overflow-y: auto;
            border-right: 1px solid #333;
            padding: 10px;
        }

        .category-title {
            padding: 10px;
            background: #2c3e50;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
        }

        .stream-list {
            margin-left: 15px;
            display: none;
        }

        .stream-list.active {
            display: block;
        }

        .stream-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 4px;
            transition: background-color 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .stream-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .stream-item.active {
            background: #3498db;
        }

        .player-wrapper {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            position: relative;
            padding: 20px;
        }

        #videoPlayer {
            max-width: 80%;
            max-height: 80vh;
            width: auto;
            height: auto;
            margin: auto;
        }

        .header {
            padding: 15px;
            background: rgba(0, 0, 0, 0.8);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: opacity 0.3s;
        }

        .header.hidden {
            opacity: 0;
        }

        .stream-title {
            font-size: 1.2em;
            margin: 0;
            color: #fff;
        }

        .controls {
            position: fixed;
            top: 70px;
            right: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            gap: 10px;
            border-radius: 8px;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .controls.hidden {
            opacity: 0;
        }

        .control-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.2s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .control-btn i {
            font-size: 1.2em;
        }

        /* 全屏时的样式 */
        .fullscreen .header,
        .fullscreen .controls {
            z-index: 2147483647;
        }

        .fullscreen #videoPlayer {
            width: 100vw;
            height: 100vh;
            max-height: none;
        }

        /* 加载动画 */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }

        .loading i {
            font-size: 3em;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 错误提示 */
        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(220, 53, 69, 0.9);
            padding: 15px 30px;
            border-radius: 4px;
            display: none;
        }

        /* 添加响应式设计 */
        @media (max-width: 768px) {
            .playlist-container {
                position: fixed;
                left: -300px;
                transition: left 0.3s;
                z-index: 1000;
                height: 100vh;
            }

            .playlist-container.show {
                left: 0;
            }

            .toggle-playlist {
                display: block !important;
            }
        }

        .toggle-playlist {
            display: none;
            position: fixed;
            left: 10px;
            bottom: 70px;
            z-index: 1001;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 4px;
        }

        /* 添加工具提示样式 */
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .control-btn:hover .tooltip {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="stream-title">正在加载...</h1>
        <button class="control-btn" onclick="window.close()">
            <i class="fa fa-times"></i>
        </button>
    </div>

    <div class="main-container">
        <div class="playlist-container">
            <div id="playlist"></div>
        </div>

        <div class="player-wrapper">
            <video id="videoPlayer" controls></video>
        </div>
    </div>

    <button class="toggle-playlist" onclick="togglePlaylist()">
        <i class="fa fa-list"></i>
    </button>

    <div class="controls">
        <button class="control-btn" onclick="reloadPlayer()" title="重新加载">
            <i class="fa fa-refresh"></i>
        </button>
        <button class="control-btn" onclick="toggleFullscreen()" title="全屏">
            <i class="fa fa-expand"></i>
        </button>
    </div>

    <div class="stream-info" style="position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 4px;">
        <span id="resolution">-</span> | <span id="bitrate">-</span>
    </div>

    <div class="loading">
        <i class="fa fa-spinner"></i>
    </div>

    <div class="error-message">
        播放失败，请稍后重试
    </div>

    <script>
        let hideControlsTimeout;
        const urlParams = new URLSearchParams(window.location.search);
        const streamId = urlParams.get('id');
        let hls;
        let autoReconnectTimer = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 10;
        const RECONNECT_DELAY = 5000; // 5秒后重试

        // 修改初始化播放器函数
        async function initPlayer() {
            try {
                // 获取流信息
                const response = await fetch(`/api/streams/${streamId}`);
                const stream = await response.json();
                document.querySelector('.stream-title').textContent = stream.name;

                const video = document.getElementById('videoPlayer');
                const playUrl = `/play/${streamId}`;

                if (Hls.isSupported()) {
                    if (hls) {
                        hls.destroy();
                    }

                    hls = new Hls({
                        debug: false,
                        enableWorker: true,
                        lowLatencyMode: true,
                        manifestLoadingTimeOut: 10000,    // 加载超时时间
                        manifestLoadingMaxRetry: 3,       // 最大重试次数
                        levelLoadingTimeOut: 10000,       // 级别加载超时
                        levelLoadingMaxRetry: 3,          // 级别加载重试
                        fragLoadingTimeOut: 20000,        // 片段加载超时
                        fragLoadingMaxRetry: 3,           // 片段加载重试
                        recovery: {
                            enabled: true,                // 启用恢复机制
                            maxBufferHole: 0.5,           // 最大缓冲区空洞
                            maxStarvationDelay: 5         // 最大饥饿延迟
                        }
                    });

                    hls.loadSource(playUrl);
                    hls.attachMedia(video);

                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        video.play();
                        document.querySelector('.loading').style.display = 'none';
                        document.querySelector('.error-message').style.display = 'none';
                        reconnectAttempts = 0; // 重置重连次数
                    });

                    // 监听错误事件
                    hls.on(Hls.Events.ERROR, (event, data) => {
                        console.error('HLS Error:', data);
                        if (data.fatal) {
                            switch (data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    // 网络错误，尝试重连
                                    handleStreamError();
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    // 媒体错误，尝试恢复
                                    handleMediaError();
                                    break;
                                default:
                                    // 其他致命错误
                                    handleFatalError();
                                    break;
                            }
                        }
                    });

                    // 监听视频信息更新
                    hls.on(Hls.Events.FRAG_PARSING_DATA, (event, data) => {
                        if (data.type === 'video') {
                            const resolution = `${video.videoWidth}x${video.videoHeight}`;
                            const bitrate = `${Math.round(hls.bandwidthEstimate / 1024)} Kbps`;
                            document.getElementById('resolution').textContent = resolution;
                            document.getElementById('bitrate').textContent = bitrate;
                        }
                    });
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = playUrl;
                    video.addEventListener('loadedmetadata', () => {
                        video.play();
                        document.querySelector('.loading').style.display = 'none';
                    });
                }
            } catch (error) {
                console.error('Error initializing player:', error);
                handleStreamError();
            }
        }

        // 处理流错误
        function handleStreamError() {
            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                reconnectAttempts++;
                document.querySelector('.error-message').textContent = 
                    `播放中断，正在尝试重连... (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`;
                document.querySelector('.error-message').style.display = 'block';
                document.querySelector('.loading').style.display = 'block';

                // 清除之前的重连定时器
                if (autoReconnectTimer) {
                    clearTimeout(autoReconnectTimer);
                }

                // 设置新的���连定时器
                autoReconnectTimer = setTimeout(() => {
                    reloadPlayer();
                }, RECONNECT_DELAY);
            } else {
                handleFatalError();
            }
        }

        // 处理媒体错误
        function handleMediaError() {
            if (hls) {
                hls.recoverMediaError();
            }
            document.querySelector('.error-message').textContent = '正在恢复播放...';
            document.querySelector('.error-message').style.display = 'block';
        }

        // 处理致命错误
        function handleFatalError() {
            document.querySelector('.error-message').textContent = '播放失败，请刷新页面重试';
            document.querySelector('.error-message').style.display = 'block';
            document.querySelector('.loading').style.display = 'none';
        }

        // 修改重新加载函数
        function reloadPlayer() {
            if (autoReconnectTimer) {
                clearTimeout(autoReconnectTimer);
                autoReconnectTimer = null;
            }
            document.querySelector('.loading').style.display = 'block';
            document.querySelector('.error-message').style.display = 'none';
            initPlayer();
        }

        // 切换全屏
        function toggleFullscreen() {
            const container = document.querySelector('.player-container');
            if (!document.fullscreenElement) {
                if (container.requestFullscreen) {
                    container.requestFullscreen();
                } else if (container.webkitRequestFullscreen) {
                    container.webkitRequestFullscreen();
                } else if (container.msRequestFullscreen) {
                    container.msRequestFullscreen();
                }
                document.body.classList.add('fullscreen');
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                document.body.classList.remove('fullscreen');
            }
        }

        // 自动隐藏控制栏
        function showControls() {
            const header = document.querySelector('.header');
            const controls = document.querySelector('.controls');
            header.classList.remove('hidden');
            controls.classList.remove('hidden');

            clearTimeout(hideControlsTimeout);
            hideControlsTimeout = setTimeout(() => {
                if (!document.querySelector('video').paused) {
                    header.classList.add('hidden');
                    controls.classList.add('hidden');
                }
            }, 3000);
        }

        // 监听鼠标移动
        document.addEventListener('mousemove', showControls);

        // 监听全屏变化
        document.addEventListener('fullscreenchange', () => {
            const fullscreenBtn = document.querySelector('.control-btn i.fa-expand');
            if (document.fullscreenElement) {
                fullscreenBtn.classList.remove('fa-expand');
                fullscreenBtn.classList.add('fa-compress');
            } else {
                fullscreenBtn.classList.remove('fa-compress');
                fullscreenBtn.classList.add('fa-expand');
            }
        });

        // 添加播放列表相关代码
        async function loadPlaylist() {
            try {
                const response = await fetch('/api/streams');
                const streams = await response.json();
                
                // 按分类分组
                const categories = {};
                streams.forEach(stream => {
                    const category = stream.category || '未分类';
                    if (!categories[category]) {
                        categories[category] = [];
                    }
                    categories[category].push(stream);
                });

                // 渲染播放列表
                const playlistContainer = document.getElementById('playlist');
                playlistContainer.innerHTML = '';

                for (const [category, streams] of Object.entries(categories)) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'category';
                    
                    const categoryTitle = document.createElement('div');
                    categoryTitle.className = 'category-title';
                    categoryTitle.innerHTML = `<i class="fa fa-folder"></i> ${category}`;
                    categoryTitle.onclick = () => toggleCategory(categoryTitle);

                    const streamList = document.createElement('div');
                    streamList.className = 'stream-list';

                    streams.forEach(stream => {
                        const streamItem = document.createElement('div');
                        streamItem.className = 'stream-item';
                        streamItem.dataset.streamId = stream.id;
                        if (stream.id === streamId) {
                            streamItem.classList.add('active');
                            streamList.classList.add('active');
                        }
                        streamItem.textContent = stream.name;
                        streamItem.onclick = () => switchStream(stream.id);
                        streamList.appendChild(streamItem);
                    });

                    categoryDiv.appendChild(categoryTitle);
                    categoryDiv.appendChild(streamList);
                    playlistContainer.appendChild(categoryDiv);
                }
            } catch (error) {
                console.error('Error loading playlist:', error);
            }
        }

        function toggleCategory(element) {
            const streamList = element.nextElementSibling;
            streamList.classList.toggle('active');
        }

        async function switchStream(newStreamId) {
            try {
                // 更新streamId
                streamId = newStreamId;
                
                // 更新URL参数
                const newUrl = new URL(window.location.href);
                newUrl.searchParams.set('id', streamId);
                window.history.pushState({}, '', newUrl);
                
                // 更新活动状态
                document.querySelectorAll('.stream-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // 找到对应的流项并添加active类
                const streamItems = document.querySelectorAll('.stream-item');
                for (const item of streamItems) {
                    if (item.dataset.streamId === streamId) {
                        item.classList.add('active');
                        // 展开对应的分类
                        const streamList = item.parentElement;
                        streamList.classList.add('active');
                    }
                }
                
                // 显示加载动画
                document.querySelector('.loading').style.display = 'block';
                document.querySelector('.error-message').style.display = 'none';
                
                // 重新加载播放器
                await initPlayer();
                
            } catch (error) {
                console.error('Error switching stream:', error);
                document.querySelector('.error-message').textContent = '切换频道失败，请重试';
                document.querySelector('.error-message').style.display = 'block';
            }
        }

        function togglePlaylist() {
            document.querySelector('.playlist-container').classList.toggle('show');
        }

        // 在初始化时加载播放列��
        loadPlaylist();

        // 启动播放器
        initPlayer();
    </script>
</body>
</html> 