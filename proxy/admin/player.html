<!DOCTYPE html>
<html>
<head>
    <title>流媒体播放器</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://lib.baomitu.com/dplayer/1.27.1/DPlayer.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            font-family: "Microsoft YaHei", Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 60px);
            margin-top: 60px;
        }

        .playlist-container {
            width: 300px;
            background: rgba(0, 0, 0, 0.9);
            overflow-y: auto;
            border-right: 1px solid #333;
            padding: 10px;
        }

        .player-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #000;
            position: relative;
        }

        #dplayer {
            flex: 1;
            width: 100%;
            height: 100%;
        }

        .category-title {
            padding: 10px;
            background: #2c3e50;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stream-list {
            margin-left: 15px;
            display: none;
        }

        .stream-list.active {
            display: block;
        }

        .stream-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 4px;
            transition: all 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .stream-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .stream-item.active {
            background: #3498db;
            color: white;
        }

        .header {
            padding: 15px;
            background: rgba(0, 0, 0, 0.8);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stream-title {
            font-size: 1.2em;
            margin: 0;
            color: #fff;
        }

        @media (max-width: 768px) {
            .playlist-container {
                position: fixed;
                left: -300px;
                height: 100vh;
                transition: left 0.3s;
                z-index: 1001;
            }

            .playlist-container.show {
                left: 0;
            }

            .toggle-playlist {
                display: block !important;
            }
        }

        .toggle-playlist {
            display: none;
            position: fixed;
            left: 10px;
            bottom: 70px;
            z-index: 1002;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 4px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="stream-title">正在���载...</h1>
        <button class="btn btn-outline-light btn-sm" onclick="window.close()">
            <i class="fa fa-times"></i>
        </button>
    </div>

    <div class="main-container">
        <div class="playlist-container">
            <div id="playlist"></div>
        </div>

        <div class="player-wrapper">
            <div id="dplayer"></div>
        </div>
    </div>

    <button class="toggle-playlist" onclick="togglePlaylist()">
        <i class="fa fa-list"></i>
    </button>

    <div class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <script src="https://lib.baomitu.com/dplayer/1.27.1/DPlayer.min.js"></script>
    <script src="https://lib.baomitu.com/hls.js/1.4.10/hls.min.js"></script>
    <script>
        let dp = null;
        const urlParams = new URLSearchParams(window.location.search);
        let streamId = urlParams.get('id');
        let autoReconnectTimer = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 10;
        const RECONNECT_DELAY = 5000;

        async function initPlayer() {
            try {
                // 获取流信息
                const response = await fetch(`/api/streams/${streamId}`);
                const stream = await response.json();
                document.querySelector('.stream-title').textContent = stream.name;

                const playUrl = `/play/${streamId}`;

                // 销毁现有播放器
                if (dp) {
                    dp.destroy();
                    dp = null;
                }

                // 创建新的DPlayer实例，添加更多HLS配置
                dp = new DPlayer({
                    container: document.getElementById('dplayer'),
                    video: {
                        url: playUrl,
                        type: 'hls',
                        autoplay: true,
                        hlsjsConfig: {
                            debug: false,
                            // HLS配置
                            fragLoadingTimeOut: 20000,        // 片段加载超时
                            manifestLoadingTimeOut: 20000,    // 清单加载超时
                            levelLoadingTimeOut: 20000,       // 级别加载超时
                            maxBufferLength: 30,              // 最大缓冲长度（秒）
                            maxMaxBufferLength: 60,           // 绝对最大缓冲长度
                            maxBufferSize: 200 * 1000 * 1000, // 最大缓冲大小（字节）
                            maxBufferHole: 0.5,              // 最大缓冲空洞
                            lowLatencyMode: true,            // 低延迟模式
                            backBufferLength: 30,            // 后退缓冲长度
                            enableWorker: true,              // 启用Web Worker
                            startLevel: -1,                  // 自动选择起始质量
                            abrEwmaFastLive: 3.0,           // 实时流ABR快速EWMA
                            abrEwmaSlowLive: 9.0,           // 实时流ABR慢速EWMA
                            liveSyncDurationCount: 3,        // 同步持续时间计数
                            liveMaxLatencyDurationCount: 10, // 最大延迟持续时间计数
                            liveDurationInfinity: true,      // 无限直播持续时间
                            liveBackBufferLength: 0,         // 禁用实时回退缓冲
                            // 错误恢复配置
                            recovery: {
                                enabled: true,               // 启用错误恢复
                                errorRetryInterval: 1000,    // 错误重试间隔
                                maxErrorRetry: 3,            // 最大错误重试次数
                                maxStarvationDelay: 4,       // 最大饥饿延迟
                                maxLoadingDelay: 4           // 最大加载延迟
                            }
                        }
                    },
                    theme: '#3498db',
                    hotkey: true,
                    preload: 'auto',
                    volume: 1,
                    playbackSpeed: [0.5, 0.75, 1, 1.25, 1.5, 2],
                    contextmenu: [
                        {
                            text: '刷新播放器',
                            click: () => reloadPlayer()
                        }
                    ]
                });

                // 监听错误事件
                dp.on('error', () => {
                    handleStreamError();
                });

                // 监听播放开始事件
                dp.on('loadstart', () => {
                    dp.play();
                });

                // 监听播放器就绪事件
                dp.on('loadedmetadata', () => {
                    dp.play().catch(error => {
                        console.warn('Autoplay failed:', error);
                    });
                    document.querySelector('.loading-overlay').style.display = 'none';
                });

                // 添加缓冲监听
                dp.on('waiting', () => {
                    console.log('Player waiting for data...');
                });

                // 添加播放状态监听
                dp.on('playing', () => {
                    console.log('Player started playing');
                    document.querySelector('.loading-overlay').style.display = 'none';
                });

                // 监听HLS事件
                if (dp.plugins.hls) {
                    dp.plugins.hls.on(Hls.Events.ERROR, (event, data) => {
                        console.log('HLS Error:', data);
                        if (data.fatal) {
                            handleStreamError();
                        }
                    });

                    // 监听片段加载事件
                    dp.plugins.hls.on(Hls.Events.FRAG_LOADED, () => {
                        console.log('Fragment loaded successfully');
                    });
                }

                // 隐藏加载动画
                document.querySelector('.loading-overlay').style.display = 'none';
            } catch (error) {
                console.error('Error initializing player:', error);
                handleStreamError();
            }
        }

        // 修改切换流的函数
        async function switchStream(newStreamId) {
            try {
                // 显示加载动画
                document.querySelector('.loading-overlay').style.display = 'flex';
                
                // 更新streamId
                streamId = newStreamId;
                
                // 更新URL参数
                const newUrl = new URL(window.location.href);
                newUrl.searchParams.set('id', streamId);
                window.history.pushState({}, '', newUrl);
                
                // 更新活动状态
                document.querySelectorAll('.stream-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.streamId === streamId) {
                        item.classList.add('active');
                        const streamList = item.parentElement;
                        streamList.classList.add('active');
                    }
                });

                // 重置重连计数
                reconnectAttempts = 0;
                
                // 销毁现有播放器并重新初始化
                if (dp) {
                    dp.destroy();
                    dp = null;
                }
                
                // 等待一小段时间确保清理完成
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 重新初始化播放器
                await initPlayer();
                
            } catch (error) {
                console.error('Error switching stream:', error);
                document.querySelector('.loading-overlay').style.display = 'none';
                alert('切换频道失败，请重试');
            }
        }

        // 修改错误处理函数
        function handleStreamError() {
            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                reconnectAttempts++;
                document.querySelector('.loading-overlay').style.display = 'flex';
                
                if (autoReconnectTimer) {
                    clearTimeout(autoReconnectTimer);
                }

                autoReconnectTimer = setTimeout(() => {
                    reloadPlayer();
                }, RECONNECT_DELAY);
            } else {
                document.querySelector('.loading-overlay').style.display = 'none';
                alert('播放失败，请刷新页面重试');
            }
        }

        // 修改重新加载函数
        function reloadPlayer() {
            reconnectAttempts = 0;
            if (autoReconnectTimer) {
                clearTimeout(autoReconnectTimer);
            }
            document.querySelector('.loading-overlay').style.display = 'flex';
            
            // 确保完全销毁现有播放器
            if (dp) {
                dp.destroy();
                dp = null;
            }
            
            // 短暂延迟后重新初始化
            setTimeout(() => {
                initPlayer();
            }, 1000);
        }

        async function loadPlaylist() {
            try {
                const response = await fetch('/api/streams');
                const streams = await response.json();
                
                const categories = {};
                streams.forEach(stream => {
                    const category = stream.category || '未分类';
                    if (!categories[category]) {
                        categories[category] = [];
                    }
                    categories[category].push(stream);
                });

                const playlistContainer = document.getElementById('playlist');
                playlistContainer.innerHTML = '';

                for (const [category, streams] of Object.entries(categories)) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'category';
                    
                    const categoryTitle = document.createElement('div');
                    categoryTitle.className = 'category-title';
                    categoryTitle.innerHTML = `
                        <span><i class="fa fa-folder"></i> ${category}</span>
                        <span class="badge bg-secondary">${streams.length}</span>
                    `;
                    categoryTitle.onclick = () => toggleCategory(categoryTitle);

                    const streamList = document.createElement('div');
                    streamList.className = 'stream-list';

                    streams.forEach(stream => {
                        const streamItem = document.createElement('div');
                        streamItem.className = 'stream-item';
                        streamItem.dataset.streamId = stream.id;
                        if (stream.id === streamId) {
                            streamItem.classList.add('active');
                            streamList.classList.add('active');
                        }
                        streamItem.innerHTML = `
                            <i class="fa fa-play-circle-o"></i> ${stream.name}
                        `;
                        streamItem.onclick = () => switchStream(stream.id);
                        streamList.appendChild(streamItem);
                    });

                    categoryDiv.appendChild(categoryTitle);
                    categoryDiv.appendChild(streamList);
                    playlistContainer.appendChild(categoryDiv);
                }
            } catch (error) {
                console.error('Error loading playlist:', error);
            }
        }

        function toggleCategory(element) {
            const streamList = element.nextElementSibling;
            streamList.classList.toggle('active');
            
            // 切换文件夹图标
            const icon = element.querySelector('.fa');
            if (streamList.classList.contains('active')) {
                icon.classList.remove('fa-folder');
                icon.classList.add('fa-folder-open');
            } else {
                icon.classList.remove('fa-folder-open');
                icon.classList.add('fa-folder');
            }
        }

        function togglePlaylist() {
            document.querySelector('.playlist-container').classList.toggle('show');
        }

        // 初始化
        loadPlaylist();
        initPlayer();
    </script>
</body>
</html> 