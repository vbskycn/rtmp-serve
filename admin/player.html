<!DOCTYPE html>
<html>
<head>
    <title>流媒体播放器</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://lib.baomitu.com/dplayer/1.27.1/DPlayer.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            font-family: "Microsoft YaHei", Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 60px);
            margin-top: 60px;
        }

        .playlist-container {
            width: 300px;
            background: rgba(0, 0, 0, 0.9);
            overflow-y: auto;
            border-right: 1px solid #333;
            padding: 10px;
        }

        .player-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #000;
            position: relative;
        }

        #dplayer {
            flex: 1;
            width: 100%;
            height: 100%;
        }

        .category-title {
            padding: 10px;
            background: #2c3e50;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stream-list {
            margin-left: 15px;
            display: none;
        }

        .stream-list.active {
            display: block;
        }

        .stream-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 4px;
            transition: all 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .stream-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .stream-item.active {
            background: #3498db;
            color: white;
        }

        .header {
            padding: 15px;
            background: rgba(0, 0, 0, 0.8);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stream-title {
            font-size: 1.2em;
            margin: 0;
            color: #fff;
        }

        @media (max-width: 768px) {
            .playlist-container {
                position: fixed;
                left: -300px;
                height: 100vh;
                transition: left 0.3s;
                z-index: 1001;
            }

            .playlist-container.show {
                left: 0;
            }

            .toggle-playlist {
                display: block !important;
            }
        }

        .toggle-playlist {
            display: none;
            position: fixed;
            left: 10px;
            bottom: 70px;
            z-index: 1002;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 4px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="stream-title">正在���载...</h1>
        <button class="btn btn-outline-light btn-sm" onclick="window.close()">
            <i class="fa fa-times"></i>
        </button>
    </div>

    <div class="main-container">
        <div class="playlist-container">
            <div id="playlist"></div>
        </div>

        <div class="player-wrapper">
            <div id="dplayer"></div>
        </div>
    </div>

    <button class="toggle-playlist" onclick="togglePlaylist()">
        <i class="fa fa-list"></i>
    </button>

    <div class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <script src="https://lib.baomitu.com/dplayer/1.27.1/DPlayer.min.js"></script>
    <script src="https://lib.baomitu.com/flv.js/1.6.2/flv.min.js"></script>
    <script>
        let dp = null;
        const urlParams = new URLSearchParams(window.location.search);
        let streamId = urlParams.get('id');
        let autoReconnectTimer = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 10;
        const RECONNECT_DELAY = 5000;

        async function initPlayer(playUrl) {
            try {
                // 获取流信息
                const response = await fetch(`/api/streams/${streamId}`);
                const stream = await response.json();
                document.querySelector('.stream-title').textContent = stream.name;

                // 获取服务器配置
                const configResponse = await fetch('/api/config');
                const config = await configResponse.json();
                
                // 使用正确的播放地址
                const actualPlayUrl = stream.processRunning ? 
                    `${config.rtmp.pullServer}${stream.id}.flv` : 
                    null;

                if (!actualPlayUrl) {
                    throw new Error('Stream is not running');
                }

                // 销毁现有播放器
                if (dp) {
                    dp.destroy();
                    dp = null;
                }

                // 创建新的DPlayer实例
                dp = new DPlayer({
                    container: document.getElementById('dplayer'),
                    live: true,
                    video: {
                        url: actualPlayUrl,
                        type: 'flv',  // 使用 flv 类型
                        autoplay: true,
                        flvjs: {
                            // flv.js 配置
                            enableStashBuffer: false,  // 禁用缓存，降低延迟
                            stashInitialSize: 128,    // 减小初始缓存大小
                            enableWorker: true,       // 启用 web worker
                            lazyLoad: false,          // 禁用延迟加载
                            seekType: 'range',        // 使用 range 请求
                            hasAudio: true,           // 包含音频
                            hasVideo: true,           // 包含视频
                            
                            // 错误恢复配置
                            autoCleanupSourceBuffer: true,  // 自动清理缓冲区
                            autoCleanupMaxBackwardDuration: 5,  // 最大后退时长
                            autoCleanupMinBackwardDuration: 1,  // 最小后退时长
                            
                            // 直播流优化
                            isLive: true,             // 标记为直播流
                            cors: true,               // 启用跨域
                            withCredentials: false,    // 禁用认证
                            
                            // 性能优化
                            enableWorker: true,       // 启用 web worker
                            accurateSeek: false,      // 禁用精确跳转
                            reuseRedirectedURL: true, // 重用重定向URL
                            
                            // 缓冲区配置
                            fixAudioTimestampGap: true,  // 修复音频时间戳间隙
                        }
                    },
                    theme: '#3498db',
                    hotkey: true,
                    preload: 'auto',
                    volume: 1,
                    playbackSpeed: [0.5, 0.75, 1, 1.25, 1.5, 2],
                    contextmenu: [
                        {
                            text: '刷新播放器',
                            click: () => reloadPlayer()
                        }
                    ]
                });

                // 添加播放器事件监听
                dp.on('error', () => {
                    console.log('Player error, attempting recovery...');
                    if (dp.plugins.flv) {
                        // 尝试恢复播放
                        dp.plugins.flv.unload();
                        dp.plugins.flv.load();
                        dp.play();
                    }
                });

                // 隐藏加载动画
                document.querySelector('.loading-overlay').style.display = 'none';

            } catch (error) {
                console.error('Error initializing player:', error);
                handleStreamError();
            }
        }

        // 修改切换流的函数
        async function switchStream(newStreamId, playUrl) {
            try {
                // 显示加载动画
                document.querySelector('.loading-overlay').style.display = 'flex';
                
                // 更新streamId
                streamId = newStreamId;
                
                // 更新URL参数
                const newUrl = new URL(window.location.href);
                newUrl.searchParams.set('id', streamId);
                window.history.pushState({}, '', newUrl);
                
                // 更新活动状态
                document.querySelectorAll('.stream-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.streamId === streamId) {
                        item.classList.add('active');
                        const streamList = item.parentElement;
                        streamList.classList.add('active');
                    }
                });

                // 重置重连计数
                reconnectAttempts = 0;
                
                // 销毁现有播放器并重新初始化
                if (dp) {
                    dp.destroy();
                    dp = null;
                }
                
                // 等待一小段时间确保清理完成
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 使用传入的播放地址初始化播放器
                await initPlayer(playUrl);

                // 更新页面标题
                const streamItem = document.querySelector(`.stream-item[data-stream-id="${streamId}"]`);
                if (streamItem) {
                    document.title = streamItem.textContent.trim();
                    document.querySelector('.stream-title').textContent = streamItem.textContent.trim();
                }

            } catch (error) {
                console.error('Error switching stream:', error);
                document.querySelector('.loading-overlay').style.display = 'none';
                alert('切换频道失败，请重试');
            }
        }

        // 修改错误处理函数
        function handleStreamError() {
            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                reconnectAttempts++;
                document.querySelector('.loading-overlay').style.display = 'flex';
                
                if (autoReconnectTimer) {
                    clearTimeout(autoReconnectTimer);
                }

                autoReconnectTimer = setTimeout(() => {
                    reloadPlayer();
                }, RECONNECT_DELAY);
            } else {
                document.querySelector('.loading-overlay').style.display = 'none';
                alert('播放失败，请刷新页面重试');
            }
        }

        // 修改重新加载函数
        function reloadPlayer() {
            reconnectAttempts = 0;
            if (autoReconnectTimer) {
                clearTimeout(autoReconnectTimer);
            }
            document.querySelector('.loading-overlay').style.display = 'flex';
            
            // 确保完全销毁现有播放器
            if (dp) {
                dp.destroy();
                dp = null;
            }
            
            // 短暂延迟后重新初始化
            setTimeout(() => {
                initPlayer();
            }, 1000);
        }

        async function loadPlaylist() {
            try {
                // 获取服务器配置
                const configResponse = await fetch('/api/config');
                const config = await configResponse.json();
                
                // 获取所有流
                const response = await fetch('/api/streams');
                const allStreams = await response.json();
                
                // 只过滤出正在推流的流
                const activeStreams = allStreams.filter(stream => stream.processRunning);
                
                // 按分类组织
                const categories = {};
                activeStreams.forEach(stream => {
                    const category = stream.category || '未分类';
                    if (!categories[category]) {
                        categories[category] = [];
                    }
                    // 使用正确的播放地址格式
                    stream.playUrl = `${config.rtmp.pullServer}${stream.id}.flv`;
                    categories[category].push(stream);
                });

                const playlistContainer = document.getElementById('playlist');
                playlistContainer.innerHTML = '';

                // 如果没有正在推流的流，显示提示
                if (activeStreams.length === 0) {
                    playlistContainer.innerHTML = `
                        <div class="p-3 text-center text-muted">
                            <i class="fa fa-info-circle fa-2x mb-2"></i>
                            <p>当前没有正在推流的频道</p>
                        </div>
                    `;
                    return;
                }

                // 渲染分类和流列表
                for (const [category, streams] of Object.entries(categories)) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'category';
                    
                    const categoryTitle = document.createElement('div');
                    categoryTitle.className = 'category-title';
                    categoryTitle.innerHTML = `
                        <span><i class="fa fa-folder"></i> ${category}</span>
                        <span class="badge bg-success">${streams.length}</span>
                    `;
                    categoryTitle.onclick = () => toggleCategory(categoryTitle);

                    const streamList = document.createElement('div');
                    streamList.className = 'stream-list';

                    streams.forEach(stream => {
                        const streamItem = document.createElement('div');
                        streamItem.className = 'stream-item';
                        streamItem.dataset.streamId = stream.id;
                        streamItem.dataset.playUrl = stream.playUrl;  // 保存播放地址
                        
                        if (stream.id === streamId) {
                            streamItem.classList.add('active');
                            streamList.classList.add('active');
                        }
                        
                        streamItem.innerHTML = `
                            <i class="fa fa-play-circle-o"></i> ${stream.name}
                        `;
                        streamItem.onclick = () => switchStream(stream.id, stream.playUrl);
                        streamList.appendChild(streamItem);
                    });

                    categoryDiv.appendChild(categoryTitle);
                    categoryDiv.appendChild(streamList);
                    playlistContainer.appendChild(categoryDiv);
                }

                // 自动展开当前流所在的分类
                const activeItem = playlistContainer.querySelector('.stream-item.active');
                if (activeItem) {
                    const parentList = activeItem.closest('.stream-list');
                    if (parentList) {
                        parentList.classList.add('active');
                        const categoryTitle = parentList.previousElementSibling;
                        if (categoryTitle) {
                            const icon = categoryTitle.querySelector('.fa');
                            icon.classList.remove('fa-folder');
                            icon.classList.add('fa-folder-open');
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading playlist:', error);
                // 显示错误提示
                document.getElementById('playlist').innerHTML = `
                    <div class="p-3 text-center text-danger">
                        <i class="fa fa-exclamation-circle fa-2x mb-2"></i>
                        <p>加载播放列表失败</p>
                    </div>
                `;
            }
        }

        function toggleCategory(element) {
            const streamList = element.nextElementSibling;
            streamList.classList.toggle('active');
            
            // 切换文件夹图标
            const icon = element.querySelector('.fa');
            if (streamList.classList.contains('active')) {
                icon.classList.remove('fa-folder');
                icon.classList.add('fa-folder-open');
            } else {
                icon.classList.remove('fa-folder-open');
                icon.classList.add('fa-folder');
            }
        }

        function togglePlaylist() {
            document.querySelector('.playlist-container').classList.toggle('show');
        }

        // 初始化
        loadPlaylist();
        initPlayer();

        // 修改定时刷新逻辑，每30秒更新一次播放列表
        setInterval(loadPlaylist, 30000);
    </script>
</body>
</html> 