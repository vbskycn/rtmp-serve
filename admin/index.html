<!DOCTYPE html>
<html>
<head>
    <title>流媒体管理系统</title>
    <link href="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <!-- 顶部状态栏 -->
    <div class="top-bar">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="system-title">流媒体管理系统 <span class="version-text">v加载中...</span></h1>
            <div class="d-flex align-items-center">
                <!-- 刷新按钮 -->
                <button onclick="refreshPage()" class="btn btn-light btn-sm me-3" title="刷新页面">
                    <i class="fa fa-refresh"></i> 刷新页面
                </button>
                <div class="stats-container">
                    <div class="stat-item">
                        <span class="stat-label">总流数量:</span>
                        <span class="stat-value" id="totalStreams">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">活跃流数量:</span>
                        <span class="stat-value" id="activeStreams">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">本次启动运行时间:</span>
                        <span class="stat-value" id="systemUptime">刚刚启动</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">接收流量:</span>
                        <span class="stat-value" id="trafficReceived">0 B</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">发送流量:</span>
                        <span class="stat-value" id="trafficSent">0 B</span>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <div class="btn-group">
                        <!-- 重启服务器按钮移到这里 -->
                        <button onclick="restartServer()" class="btn btn-danger btn-sm" title="重启服务器">
                            <i class="fa fa-refresh"></i> 重启服务器
                        </button>
                        <button class="btn btn-light btn-sm" onclick="showChangePasswordModal()">
                            <i class="fa fa-key"></i> 修改密码
                        </button>
                        <button class="btn btn-light btn-sm" onclick="logout()">
                            <i class="fa fa-sign-out"></i> 退出
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 工具面板 -->
        <div class="tools-panel">
            <div class="tools-toggle" onclick="toggleTools()">
                <i class="fa fa-cogs"></i> 管理工具
                <i class="fa fa-chevron-down float-end"></i>
            </div>
            <div class="tools-content" id="toolsContent">
                <div class="row">
                    <!-- 添加流 -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fa fa-plus-circle"></i> 添加流</h6>
                            </div>
                            <div class="card-body">
                                <form id="addStreamForm">
                                    <div class="mb-3">
                                        <label class="form-label">分类</label>
                                        <input type="text" class="form-control" id="streamCategory" placeholder="例如: 新闻、体育、综艺等">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">流名称</label>
                                        <input type="text" class="form-control" id="streamName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">源地址</label>
                                        <input type="text" class="form-control" id="streamUrl" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">自定义ID（可选）</label>
                                        <input type="text" class="form-control" id="streamCustomId" placeholder="留空将自动生成">
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fa fa-plus"></i> 添加流
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- 批量导入 -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fa fa-upload"></i> 批量导入流</h6>
                            </div>
                            <div class="card-body">
                                <form id="batchImportForm">
                                    <div class="mb-3">
                                        <label class="form-label">批量导入（支持分类格式，例如: 分类名,#genre# 开头的新行）</label>
                                        <textarea class="form-control" id="batchStreams" rows="8" placeholder="例如：
弯弯新聞,#genre#
民視新聞台,http://example.com/stream1
中視新聞台,http://example.com/stream2

弯弯綜合,#genre#
民視,http://example.com/stream3
民視第一台,http://example.com/stream4"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fa fa-upload"></i> 批量导入
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 修改服务器配置部分 -->
                    <div class="col-md-12 mt-3">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fa fa-server"></i> 服务器配置</h6>
                            </div>
                            <div class="card-body">
                                <form id="serverConfigForm" class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">服务器地址</label>
                                            <input type="text" class="form-control" id="serverHost" placeholder="auto表示自动获取">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">端口</label>
                                            <input type="number" class="form-control" id="serverPort">
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fa fa-save"></i> 保存配置
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 流列表 -->
        <div class="stream-list-container">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fa fa-list"></i> 流列表</h5>
                    <div class="btn-group">
                        <button onclick="batchStop()" class="btn btn-secondary btn-sm" id="batchStopBtn" disabled>
                            <i class="fa fa-stop"></i> 批量停止
                        </button>
                        <button onclick="batchDelete()" class="btn btn-danger btn-sm" id="batchDeleteBtn" disabled>
                            <i class="fa fa-trash"></i> 批量删除
                        </button>
                        <button onclick="batchStartRtmpPush()" class="btn btn-success btn-sm" id="batchStartBtn" disabled>
                            <i class="fa fa-play"></i> 批量推流
                        </button>
                        <button onclick="batchAutoStart(true)" class="btn btn-outline-success btn-sm" id="batchAutoStartOnBtn" disabled>
                            <i class="fa fa-sun-o"></i> 批量自启开
                        </button>
                        <button onclick="batchAutoStart(false)" class="btn btn-warning btn-sm" id="batchAutoStartOffBtn" disabled 
                                style="background-color: #ffc107; color: #000; font-weight: bold;">
                            <i class="fa fa-moon-o"></i> 批量自启关
                        </button>
                        <div class="btn-group">
                            <button onclick="exportRtmpM3U()" class="btn btn-light btn-sm">
                                <i class="fa fa-download"></i> 导出远程推流M3U
                            </button>
                            <button onclick="exportRtmpTXT()" class="btn btn-light btn-sm">
                                <i class="fa fa-download"></i> 导出远程推流TXT
                            </button>
                            <button onclick="exportSourceTXT()" class="btn btn-light btn-sm">
                                <i class="fa fa-download"></i> 导出源地址TXT
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th class="check-column" style="width: 3%">
                                        <input type="checkbox" id="selectAll" onclick="toggleSelectAll()">
                                    </th>
                                    <th style="width: 10%">名称</th>            <!-- 增加名称列宽度 -->
                                    <th style="width: 7%">状态</th>             <!-- 调整状态列宽度 -->
                                    <th style="width: 16%">推流状态</th>        <!-- 调整推流状态列宽度 -->
                                    <th style="width: 14%">源地址</th>          <!-- 调整源地址列宽度 -->
                                    <th style="width: 22%">播放地址</th>        <!-- 调整播放地址列宽度 -->
                                    <th style="width: 28%">操作</th>            <!-- 调整操作列宽度 -->
                                </tr>
                            </thead>
                            <tbody id="streamTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 在 body 标签束前添加编辑模态框 -->
    <div class="modal fade" id="editStreamModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑流</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editStreamForm">
                        <input type="hidden" id="editStreamId">
                        <div class="mb-3">
                            <label class="form-label">分类</label>
                            <input type="text" class="form-control" id="editStreamCategory">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">名称</label>
                            <input type="text" class="form-control" id="editStreamName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">源址</label>
                            <input type="text" class="form-control" id="editStreamUrl" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveStreamEdit()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 在body末尾添加修改密码模态框 -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">修改密码</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label class="form-label">旧密码</label>
                            <input type="password" class="form-control" id="oldPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">新密码</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">确认新密码</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="changePassword()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 在body末尾添加脚本引用 -->
    <script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/export.js"></script>
    <script src="js/streamManager.js"></script>
    <script>
        // 保留全局变量
        let serverConfig = null;

        // 获取服务器配置
        async function getServerConfig() {
            try {
                const response = await fetch('/api/config');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                serverConfig = await response.json();
                
                // 更新版本号显示
                if (serverConfig.version) {
                    document.title = `流媒体管理系统 v${serverConfig.version}`;
                    const versionElement = document.querySelector('.version-text');
                    if (versionElement) {
                        versionElement.textContent = `v${serverConfig.version}`;
                    }
                }
                
                return serverConfig;
            } catch (error) {
                console.error('Error loading server config:', error);
                const versionElement = document.querySelector('.version-text');
                if (versionElement) {
                    versionElement.textContent = 'v加载失败';
                }
                throw error;
            }
        }

        // 加载流列表
        async function loadStreams() {
            try {
                const response = await fetch('/api/streams');
                const streams = await response.json();
                
                // 验证流数据的完整性
                const validStreams = streams.filter(stream => {
                    if (!stream.name) {
                        console.warn(`Stream ${stream.id} has no name`);
                        stream.name = '未命名流';
                    }
                    return true;
                });

                // 更新统计数据
                updateStatElement('totalStreams', validStreams.length);
                updateStatElement('activeStreams', validStreams.filter(s => 
                    s.processRunning || s.stats?.startTime
                ).length);

                // 按分类分组
                const groupedStreams = {};
                validStreams.forEach(stream => {
                    const category = stream.category || '未分类';
                    if (!groupedStreams[category]) {
                        groupedStreams[category] = [];
                    }
                    groupedStreams[category].push(stream);
                });

                const tbody = document.querySelector('#streamTable');
                
                // 检查是否需要完全重新渲染
                const needsFullRerender = checkIfNeedsFullRerender(tbody, groupedStreams);
                
                if (needsFullRerender) {
                    const newTbody = document.createElement('tbody');
                    newTbody.id = 'streamTable';
                    renderFullTable(newTbody, groupedStreams);
                    
                    tbody.style.transition = 'opacity 0.3s';
                    tbody.style.opacity = '0';
                    
                    setTimeout(() => {
                        tbody.parentNode.replaceChild(newTbody, tbody);
                        requestAnimationFrame(() => {
                            newTbody.style.opacity = '1';
                        });
                    }, 300);
                } else {
                    updateExistingRows(tbody, groupedStreams);
                }
            } catch (error) {
                console.error('Error loading streams:', error);
            }
        }

        // 检查是否需要完全重新渲染
        function checkIfNeedsFullRerender(tbody, groupedStreams) {
            const currentIds = Array.from(tbody.querySelectorAll('tr[data-stream-id]'))
                .map(row => row.dataset.streamId);
            
            const newIds = Object.values(groupedStreams)
                .flat()
                .map(stream => stream.id);
            
            if (currentIds.length !== newIds.length) return true;
            return !currentIds.every((id, index) => id === newIds[index]);
        }

        // 更新现有行
        function updateExistingRows(tbody, groupedStreams) {
            Object.values(groupedStreams)
                .flat()
                .forEach(stream => {
                    const row = tbody.querySelector(`tr[data-stream-id="${stream.id}"]`);
                    if (row) {
                        updateRowElements(row, stream);
                    }
                });
        }

        // 更新行元素
        function updateRowElements(row, stream) {
            // 更新状态
            const statusSpan = row.querySelector('.status');
            if (statusSpan) {
                let statusClass = '';
                let statusText = '';
                let statusStyle = '';
                
                if (stream.status === 'invalid') {
                    statusClass = 'error';
                    statusText = '已失效';
                    statusStyle = 'background-color: #dc3545;';
                } else if (stream.processRunning && stream.status === 'running') {
                    statusClass = 'active';
                    statusText = '运行中';
                    statusStyle = 'background-color: #28a745;';
                } else {
                    statusClass = 'inactive';
                    statusText = '已停止';
                    statusStyle = 'background-color: #6c757d;';
                }
                
                if (statusSpan.textContent !== statusText) {
                    statusSpan.className = `status ${statusClass}`;
                    statusSpan.style = statusStyle;
                    statusSpan.textContent = statusText;
                }
            }

            // 更新推流状态
            const rtmpStatus = row.querySelector('.rtmp-status');
            if (rtmpStatus) {
                const newStatus = stream.processRunning ? '已推流' : '未推流';
                const newColor = stream.processRunning ? '#28a745' : '#6c757d';
                
                if (rtmpStatus.textContent !== newStatus) {
                    rtmpStatus.style.backgroundColor = newColor;
                    rtmpStatus.textContent = newStatus;
                }
            }

            // 更新播放地址
            const playUrlInput = row.querySelector('td:nth-child(6) input.form-control');
            if (playUrlInput) {
                const newPlayUrl = stream.processRunning ? 
                    `${serverConfig.rtmp.pullServer}${stream.id}.flv` : 
                    '未推流';
                    
                if (playUrlInput.value !== newPlayUrl) {
                    playUrlInput.value = newPlayUrl;
                    
                    // 更新复制和播放按钮状态
                    const copyBtn = playUrlInput.parentElement.querySelector('.btn-outline-primary');
                    const playBtn = playUrlInput.parentElement.querySelector('.btn-outline-success');
                    
                    if (stream.processRunning) {
                        copyBtn.disabled = false;
                        playBtn.disabled = false;
                    } else {
                        copyBtn.disabled = true;
                        playBtn.disabled = true;
                    }
                }
            }

            // 更新自启动按钮状态
            const autoStartBtn = row.querySelector('.auto-start-btn');
            if (autoStartBtn) {
                const newAutoStart = stream.autoStart;
                const currentAutoStart = autoStartBtn.classList.contains('btn-warning');
                
                if (newAutoStart !== currentAutoStart) {
                    if (newAutoStart) {
                        autoStartBtn.className = 'btn btn-warning btn-sm auto-start-btn';
                        autoStartBtn.style.backgroundColor = '#ffc107';
                        autoStartBtn.style.color = '#000';
                        autoStartBtn.innerHTML = '<i class="fa fa-moon-o"></i> 自启已开';
                    } else {
                        autoStartBtn.className = 'btn btn-outline-success btn-sm auto-start-btn';
                        autoStartBtn.style.backgroundColor = 'transparent';
                        autoStartBtn.style.color = '#28a745';
                        autoStartBtn.innerHTML = '<i class="fa fa-sun-o"></i> 自启开';
                    }
                }
            }
        }

        // 更新系统状态
        async function updateSystemStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                const uptime = formatUptime(stats.uptime);
                
                updateStatElement('totalStreams', stats.totalStreams);
                updateStatElement('activeStreams', stats.activeStreams);
                updateStatElement('systemUptime', uptime);
                updateStatElement('trafficReceived', stats.traffic.received);
                updateStatElement('trafficSent', stats.traffic.sent);
            } catch (error) {
                console.error('Error updating system stats:', error);
            }
        }

        // 初始化
        async function init() {
            try {
                await getServerConfig();
                await loadStreams();
                await updateSystemStats();
                
                let lastUpdate = 0;
                const UPDATE_INTERVAL = 5000;

                function update(timestamp) {
                    if (timestamp - lastUpdate >= UPDATE_INTERVAL) {
                        loadStreams();
                        updateSystemStats();
                        lastUpdate = timestamp;
                    }
                    requestAnimationFrame(update);
                }

                requestAnimationFrame(update);
            } catch (error) {
                console.error('Error in init:', error);
            }
        }

        // 页面加载完成后初始化
        init();

        // 事件监听器设置
        document.getElementById('addStreamForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            // 保留原有的添加流逻辑
        });

        document.getElementById('batchImportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            // 保留原有的批量导入逻辑
        });

        // 其他事件监听器...
    </script>
</body>
</html> 