<!DOCTYPE html>
<html>
<head>
    <title>流媒体管理系统</title>
    <link href="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <style>
        .auto-start-btn.btn-primary {
            background-color: #28a745;  /* 绿色 */
            border-color: #28a745;
            font-weight: bold;
        }

        .auto-start-btn.btn-danger {
            background-color: #dc3545;  /* 红色 */
            border-color: #dc3545;
            font-weight: bold;
        }

        .auto-start-btn:hover {
            transform: scale(1.05);
            transition: transform 0.2s;
        }

        .auto-start-btn i {
            margin-right: 4px;
        }

        .auto-start-btn.btn-success {
            background-color: #28a745;  /* 绿色 */
            border-color: #28a745;
            font-weight: bold;
        }

        .auto-start-btn.btn-warning {
            background-color: #ffc107;  /* 黄色 */
            border-color: #ffc107;
            font-weight: bold;
            color: #000;  /* 黄色背景配黑色文字 */
        }

        .auto-start-btn:hover {
            transform: scale(1.05);
            transition: transform 0.2s;
        }

        .auto-start-btn i {
            margin-right: 4px;
        }

        .table td {
            max-width: 0;  /* 允许单元格内容换行 */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* 源地址和名称列的特殊样式 */
        .table td:nth-child(2),  /* 名称列 */
        .table td:nth-child(3) { /* 源地址列 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 添加悬停时显示完整内容的提示 */
        .table td:nth-child(2):hover,
        .table td:nth-child(3):hover {
            white-space: normal;
            word-break: break-all;
            position: relative;
        }

        /* 确保操作按钮组不会换行 */
        .stream-actions .btn-group {
            white-space: nowrap;
        }

        /* 在现有style标签中添加 */
        .status {
            padding: 2px 8px;
            border-radius: 4px;
            color: white;
            font-size: 12px;
            display: inline-block;
            text-align: center;
            min-width: 70px;  /* 减小最小宽度 */
        }

        .gap-2 {
            gap: 0.25rem !important;  /* 减小间距 */
        }

        /* 确保推流状态单元格内容垂直居中 */
        .table td {
            vertical-align: middle;
        }

        /* 调整状态标签的样式 */
        .status {
            padding: 2px 8px;
            border-radius: 4px;
            color: white;
            font-size: 12px;
            display: inline-block;
            text-align: center;
            min-width: 70px;  /* 减小最小宽度 */
        }

        /* 调整推流状态的显示 */
        .d-flex.justify-content-between.gap-2 {
            gap: 0.25rem !important;  /* 减小间距 */
        }

        /* 调整地址输入框的样式 */
        .input-group-compact input.form-control {
            font-size: 12px;  /* 稍微减小字体大小 */
            padding: 4px 8px;  /* 减小内边距 */
        }

        /* 调整操作按钮组的样式 */
        .stream-actions .btn-group .btn {
            padding: 2px 8px;  /* 减小按钮内边距 */
            font-size: 12px;   /* 减小按钮字体大小 */
        }

        /* 确保表格单元格内容不会换行 */
        .table td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 源地址和播放地址的输入框容器样式 */
        .input-group-compact {
            width: 100%;
            display: flex;
        }

        /* 调整复制和播放按钮的样式 */
        .btn-outline-primary,
        .btn-outline-success,
        .btn-outline-secondary {
            padding: 2px 8px;
            font-size: 12px;
        }

        /* 调整表格字体和大小 */
        .table {
            font-size: 14px;  /* 增大基础字体大小 */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        /* 调整状态标签样式 */
        .status {
            padding: 3px 8px;
            border-radius: 4px;
            color: white;
            font-size: 13px;  /* 增大字体 */
            display: inline-block;
            text-align: center;
            min-width: 80px;  /* 增加最小宽度 */
            font-weight: 500;  /* 稍微加粗 */
        }

        /* 调整推流状态容器 */
        .d-flex.justify-content-between.gap-2 {
            gap: 0.5rem !important;  /* 增加间距 */
        }

        /* 调整地址输入框样式 */
        .input-group-compact input.form-control {
            font-size: 13px;  /* 增大字体 */
            padding: 4px 8px;
            font-family: Consolas, Monaco, 'Courier New', monospace;  /* 使用等宽字体 */
        }

        /* 调整操作按钮组样式 */
        .stream-actions .btn-group {
            display: flex;
            flex-wrap: nowrap;  /* 防止按钮换行 */
            gap: 2px;  /* 按钮之间的间距 */
        }

        .stream-actions .btn-group .btn {
            padding: 4px 8px;  /* 增加按钮内边距 */
            font-size: 13px;   /* 增大按钮字体 */
            white-space: nowrap;  /* 防止文字换行 */
            display: inline-flex;  /* 使用 flex 布局 */
            align-items: center;  /* 垂直居中 */
            justify-content: center;  /* 水平居中 */
            min-width: fit-content;  /* 根据内容自适应宽度 */
        }

        /* 调整复制和播放按钮样式 */
        .btn-outline-primary,
        .btn-outline-success,
        .btn-outline-secondary {
            padding: 4px 8px;
            font-size: 13px;
            white-space: nowrap;
        }

        /* 调整表格列宽度 */
        .table th:nth-child(1) { width: 3%; }   /* 复选框列 */
        .table th:nth-child(2) { width: 10%; }  /* 名称列 */
        .table th:nth-child(3) { width: 7%; }   /* 状态列 */
        .table th:nth-child(4) { width: 16%; }  /* 推流状态列 */
        .table th:nth-child(5) { width: 15%; }  /* 源地址列 */
        .table th:nth-child(6) { width: 21%; }  /* 播放地址列 */
        .table th:nth-child(7) { width: 28%; }  /* 操作列 */

        /* 确保表格内容垂直居中 */
        .table td {
            vertical-align: middle;
            padding: 8px;  /* 调整单元格内边距 */
            line-height: 1.4;  /* 调整行高 */
        }

        /* 调整图标和文字间距 */
        .btn i {
            margin-right: 4px;
            font-size: 14px;  /* 调整图标大小 */
        }

        /* 优化按钮组布局 */
        .btn-group {
            display: inline-flex;
            flex-wrap: nowrap;
            align-items: center;
        }

        /* 调整分类标题样式 */
        .bg-light strong {
            font-size: 15px;
            padding: 8px;
            display: block;
        }

        /* 优化地址显示 */
        .input-group-compact {
            max-width: 100%;
            overflow: hidden;
        }

        .input-group-compact input.form-control {
            text-overflow: ellipsis;
            background-color: #f8f9fa !important;
        }

        /* 重启按钮样式 */
        .btn-danger.btn-sm {
            font-weight: 500;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        /* 修改密码和退出按钮样式 */
        .btn-light.btn-sm {
            border-radius: 0;
        }
        
        .btn-light.btn-sm:last-child {
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
        }

        /* 确保按钮组紧凑显示 */
        .btn-group .btn + .btn {
            margin-left: -1px;
        }

        /* 重启倒计时进度条样式 */
        .progress {
            height: 10px;
            margin-top: 15px;
        }

        .fa-3x {
            font-size: 3em;
            color: #dc3545;
        }
    </style>
</head>
<body>
    <!-- 顶部状态栏 -->
    <div class="top-bar">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="system-title">流媒体管理系统 v<span id="systemVersion">加载中...</span></h1>
            <div class="d-flex align-items-center">
                <!-- 刷新按钮 -->
                <button onclick="refreshPage()" class="btn btn-light btn-sm me-3" title="刷新页面">
                    <i class="fa fa-refresh"></i> 刷新页面
                </button>
                <div class="stats-container">
                    <div class="stat-item">
                        <span class="stat-label">总流数量:</span>
                        <span class="stat-value" id="totalStreams">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">活跃流数量:</span>
                        <span class="stat-value" id="activeStreams">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">本次启动运行时间:</span>
                        <span class="stat-value" id="systemUptime">刚刚启动</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">接收流量:</span>
                        <span class="stat-value" id="trafficReceived">0 B</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">发送流量:</span>
                        <span class="stat-value" id="trafficSent">0 B</span>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <div class="btn-group">
                        <!-- 重启服务器按钮移到这里 -->
                        <button onclick="restartServer()" class="btn btn-danger btn-sm" title="重启服务器">
                            <i class="fa fa-refresh"></i> 重启服务器
                        </button>
                        <button class="btn btn-light btn-sm" onclick="showChangePasswordModal()">
                            <i class="fa fa-key"></i> 修改密码
                        </button>
                        <button class="btn btn-light btn-sm" onclick="logout()">
                            <i class="fa fa-sign-out"></i> 退出
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 工具面板 -->
        <div class="tools-panel">
            <div class="tools-toggle" onclick="toggleTools()">
                <i class="fa fa-cogs"></i> 管理工具
                <i class="fa fa-chevron-down float-end"></i>
            </div>
            <div class="tools-content" id="toolsContent">
                <div class="row">
                    <!-- 添加流 -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fa fa-plus-circle"></i> 添加流</h6>
                            </div>
                            <div class="card-body">
                                <form id="addStreamForm">
                                    <div class="mb-3">
                                        <label class="form-label">分类</label>
                                        <input type="text" class="form-control" id="streamCategory" placeholder="例如: 新闻、体育、综艺等">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">流名称</label>
                                        <input type="text" class="form-control" id="streamName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">源地址</label>
                                        <input type="text" class="form-control" id="streamUrl" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">自定义ID（可选）</label>
                                        <input type="text" class="form-control" id="streamCustomId" placeholder="留空将自动生成">
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fa fa-plus"></i> 添加流
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- 批量导入 -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fa fa-upload"></i> 批量导入流</h6>
                            </div>
                            <div class="card-body">
                                <form id="batchImportForm">
                                    <div class="mb-3">
                                        <label class="form-label">批量导入（支持分类格式，例如: 分类名,#genre# 开头的新行）</label>
                                        <textarea class="form-control" id="batchStreams" rows="8" placeholder="例如：
弯弯新聞,#genre#
民視新聞台,http://example.com/stream1
中視新聞台,http://example.com/stream2

弯弯綜合,#genre#
民視,http://example.com/stream3
民視第一台,http://example.com/stream4"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fa fa-upload"></i> 批量导入
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 修改服务器配置部分 -->
                    <div class="col-md-12 mt-3">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fa fa-server"></i> 服务器配置</h6>
                            </div>
                            <div class="card-body">
                                <form id="serverConfigForm" class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">服务器地址</label>
                                            <input type="text" class="form-control" id="serverHost" placeholder="auto表示自动获取">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">端口</label>
                                            <input type="number" class="form-control" id="serverPort">
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fa fa-save"></i> 保存配置
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 流列表 -->
        <div class="stream-list-container">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fa fa-list"></i> 流列表</h5>
                    <div class="btn-group">
                        <button onclick="batchStop()" class="btn btn-secondary btn-sm" id="batchStopBtn" disabled>
                            <i class="fa fa-stop"></i> 批量停止
                        </button>
                        <button onclick="batchDelete()" class="btn btn-danger btn-sm" id="batchDeleteBtn" disabled>
                            <i class="fa fa-trash"></i> 批量删除
                        </button>
                        <button onclick="batchAutoStart(true)" class="btn btn-success btn-sm" id="batchAutoStartOnBtn" disabled>
                            <i class="fa fa-sun-o"></i> 自启开
                        </button>
                        <button onclick="batchAutoStart(false)" class="btn btn-warning btn-sm" id="batchAutoStartOffBtn" disabled>
                            <i class="fa fa-moon-o"></i> 自启关
                        </button>
                        <button onclick="exportM3U()" class="btn btn-light btn-sm">
                            <i class="fa fa-download"></i> 导出M3U
                        </button>
                        <button onclick="exportTXT()" class="btn btn-light btn-sm">
                            <i class="fa fa-download"></i> 导出TXT
                        </button>
                        <button onclick="exportRemoteM3U()" class="btn btn-light btn-sm">
                            <i class="fa fa-download"></i> 导出远程推流M3U
                        </button>
                        <button onclick="exportRemoteTXT()" class="btn btn-light btn-sm">
                            <i class="fa fa-download"></i> 导出远程推流TXT
                        </button>
                        <button onclick="exportSourceUrls()" class="btn btn-light btn-sm">
                            <i class="fa fa-download"></i> 导出源地址
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th class="check-column" style="width: 3%">
                                        <input type="checkbox" id="selectAll" onclick="toggleSelectAll()">
                                    </th>
                                    <th style="width: 10%">名称</th>            <!-- 增加名称列宽度 -->
                                    <th style="width: 7%">状态</th>             <!-- 调整状态列宽度 -->
                                    <th style="width: 16%">推流状态</th>        <!-- 调整推流状态列宽度 -->
                                    <th style="width: 14%">源地址</th>          <!-- 调整源地址列宽度 -->
                                    <th style="width: 22%">播放地址</th>        <!-- 调整播放地址列宽度 -->
                                    <th style="width: 28%">操作</th>            <!-- 调整操作列宽度 -->
                                </tr>
                            </thead>
                            <tbody id="streamTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script src="js/export.js"></script>
    <script>
        // 在 <script> 标签开始处添加置获取
        let serverConfig = null;

        // 获取服务器配置
        async function getServerConfig() {
            try {
                const response = await fetch('/api/config');
                serverConfig = await response.json();
            } catch (error) {
                console.error('Error loading server config:', error);
            }
        }

        // 加载流列表
        async function loadStreams() {
            try {
                const response = await fetch('/api/streams');
                const streams = await response.json();
                
                // 更新统计数据（不会导致页面抖动）
                document.getElementById('totalStreams').textContent = streams.length;
                
                // 获取活跃流的数量
                const activeStreams = streams.filter(stream => {
                    return stream.processRunning || stream.stats?.startTime;
                });
                document.getElementById('activeStreams').textContent = activeStreams.length;

                // 更新系统统计信息
                try {
                    const statsResponse = await fetch('/api/stats');
                    const statsData = await statsResponse.json();
                    
                    // 平滑更新统计显示
                    updateStatElement('totalStreams', streams.length);
                    updateStatElement('activeStreams', statsData.activeStreams);
                    updateStatElement('systemUptime', formatUptime(statsData.uptime));
                    updateStatElement('trafficReceived', statsData.traffic.received);
                    updateStatElement('trafficSent', statsData.traffic.sent);
                } catch (error) {
                    console.error('Error loading system stats:', error);
                }

                // 按分类分组
                const groupedStreams = {};
                streams.forEach(stream => {
                    const category = stream.category || '未分类';
                    if (!groupedStreams[category]) {
                        groupedStreams[category] = [];
                    }
                    groupedStreams[category].push(stream);
                });

                const tbody = document.querySelector('#streamTable');
                
                // 遍历所有行，更新状态而不是重新创建
                for (const [category, categoryStreams] of Object.entries(groupedStreams)) {
                    categoryStreams.forEach(stream => {
                        const existingRow = tbody.querySelector(`tr[data-stream-id="${stream.id}"]`);
                        if (existingRow) {
                            // 只更新需要实时更新的元素
                            updateStreamRow(existingRow, stream);
                        }
                    });
                }

                // 只有在流的数量或顺序发生变化时才完全重新渲染
                const currentStreamIds = Array.from(tbody.querySelectorAll('tr[data-stream-id]'))
                    .map(row => row.dataset.streamId);
                const newStreamIds = streams.map(stream => stream.id);

                if (JSON.stringify(currentStreamIds) !== JSON.stringify(newStreamIds)) {
                    // 完全重新渲染表格
                    renderFullTable(tbody, groupedStreams);
                }
            } catch (error) {
                console.error('Error loading streams:', error);
            }
        }

        // 添加平滑更新计元素的函数
        function updateStatElement(elementId, newValue) {
            const element = document.getElementById(elementId);
            if (element.textContent !== String(newValue)) {
                element.style.transition = 'opacity 0.3s';
                element.style.opacity = '0';
                setTimeout(() => {
                    element.textContent = newValue;
                    element.style.opacity = '1';
                }, 300);
            }
        }

        // 添�����新单个流行的函数
        function updateStreamRow(row, stream) {
            // 更新状态
            const statusCell = row.querySelector('.status');
            if (statusCell) {
                let statusClass = 'inactive';
                let statusText = '已停止';
                let statusStyle = 'background-color: #6c757d;';  // 灰色

                if (stream.invalid) {
                    statusClass = 'error';
                    statusText = '已失效';
                    statusStyle = 'background-color: #dc3545;';  // 红色
                } else if (stream.status === 'error') {
                    statusClass = 'error';
                    statusText = '错误';
                    statusStyle = 'background-color: #dc3545;';  // 红色
                } else if (stream.processRunning && stream.status === 'running') {
                    statusClass = 'active';
                    statusText = '运行中';
                    statusStyle = 'background-color: #28a745;';  // 绿色
                }
                
                statusCell.className = `status ${statusClass}`;
                statusCell.style = statusStyle;
                statusCell.textContent = statusText;
            }

            // 更新推流状态
            const rtmpStatusCell = row.querySelector('.rtmp-status');
            if (rtmpStatusCell) {
                rtmpStatusCell.innerHTML = `
                    <div class="d-flex justify-content-between gap-2">
                        <span class="status flex-grow-1" style="background-color: ${stream.processRunning ? '#28a745' : '#6c757d'};">
                            ${stream.processRunning ? '已推流' : '未推流'}
                        </span>
                    </div>
                `;
            }

            // 更新自启动按钮状态
            const autoStartBtn = row.querySelector('.auto-start-btn');
            if (autoStartBtn) {
                autoStartBtn.className = `btn ${stream.autoStart ? 'btn-warning' : 'btn-success'} btn-sm auto-start-btn`;
                autoStartBtn.innerHTML = `
                    <i class="fa ${stream.autoStart ? 'fa-moon-o' : 'fa-sun-o'}"></i> 
                    ${stream.autoStart ? '自启关' : '自启开'}
                `;
                autoStartBtn.onclick = () => toggleAutoStart(stream.id, !stream.autoStart);
            }
        }

        // 修改 renderFullTable 函数
        function renderFullTable(tbody, groupedStreams) {
            tbody.style.opacity = '0';
            setTimeout(() => {
                tbody.innerHTML = '';
                for (const [category, categoryStreams] of Object.entries(groupedStreams)) {
                    // 添加分类标题行
                    const categoryRow = document.createElement('tr');
                    categoryRow.innerHTML = `
                        <td colspan="7" class="bg-light">
                            <strong>${category}</strong>
                        </td>
                    `;
                    tbody.appendChild(categoryRow);

                    // 添加流行
                    categoryStreams.forEach(stream => {
                        const tr = document.createElement('tr');
                        tr.dataset.streamId = stream.id;
                        const playUrl = `http://${serverConfig.server.host}:${serverConfig.server.port}/play/${stream.id}`;
                        
                        // 检查是否是手动启动的流
                        const isManuallyStarted = stream.manuallyStarted;
                        
                        // 修改状态判断逻辑
                        let statusClass = '';
                        let statusText = '';
                        let statusStyle = '';
                        
                        if (stream.status === 'invalid') {
                            statusClass = 'error';
                            statusText = '已失效';
                            statusStyle = 'background-color: #dc3545;';  // 红色
                        } else if (stream.status === 'running') {
                            statusClass = 'active';
                            statusText = '已运行';
                            statusStyle = 'background-color: #28a745;';  // 绿色
                        } else {
                            statusClass = 'inactive';
                            statusText = '已停止';
                            statusStyle = 'background-color: #6c757d;';  // 灰色
                        }

                        tr.innerHTML = `
                            <td>
                                <input type="checkbox" class="stream-checkbox" value="${stream.id}" 
                                       onchange="updateBatchButtons()" 
                                       ${document.getElementById('selectAll').checked ? 'checked' : ''}>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="input-group input-group-compact">
                                        <img src="${stream.tvg?.logo || ''}" alt="" style="height: 20px; margin-right: 4px;">
                                        <input type="text" class="form-control form-control-sm" value="${stream.name}" readonly 
                                               style="font-family: monospace; background-color: #f8f9fa;">
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="status ${statusClass}" style="${statusStyle}">
                                    ${statusText}
                                </span>
                            </td>
                            <td>
                                <div class="d-flex justify-content-between gap-2">
                                    <span class="status flex-grow-1" style="background-color: ${stream.processRunning ? '#28a745' : '#6c757d'};">
                                        ${stream.processRunning ? '已推流' : '未推流'}
                                    </span>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="input-group input-group-compact">
                                        <input type="text" class="form-control form-control-sm" value="${stream.url}" readonly 
                                               style="font-family: monospace; background-color: #f8f9fa;">
                                        <button class="btn btn-outline-secondary btn-sm" onclick="copyToClipboard('${stream.url}')">
                                            <i class="fa fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="input-group input-group-compact">
                                        <input type="text" class="form-control form-control-sm" value="${playUrl}" readonly 
                                               style="font-family: monospace; background-color: #f8f9fa;">
                                        <button class="btn btn-outline-primary btn-sm" onclick="copyToClipboard('${playUrl}')">
                                            <i class="fa fa-copy"></i> 复制
                                        </button>
                                        <button class="btn btn-outline-success btn-sm" onclick="window.open('player.html?id=${stream.id}', '_blank')">
                                            <i class="fa fa-play"></i> 播放
                                        </button>
                                    </div>
                                </div>
                            </td>
                            <td class="stream-actions">
                                <div class="btn-group btn-group-sm">
                                    <button onclick="editStream('${stream.id}')" class="btn btn-info btn-sm">
                                        <i class="fa fa-edit"></i> 编辑
                                    </button>
                                    <button onclick="startRtmpPush('${stream.id}')" class="btn btn-success btn-sm">
                                        <i class="fa fa-upload"></i> 推流
                                    </button>
                                    <button onclick="stopStream('${stream.id}')" class="btn btn-secondary btn-sm">
                                        <i class="fa fa-stop"></i> 停止
                                    </button>
                                    <button class="btn ${stream.autoStart ? 'btn-warning' : 'btn-success'} btn-sm auto-start-btn" 
                                            onclick="toggleAutoStart('${stream.id}', ${!stream.autoStart})">
                                        <i class="fa ${stream.autoStart ? 'fa-moon-o' : 'fa-sun-o'}"></i> 
                                        ${stream.autoStart ? '自启关' : '自启开'}
                                    </button>
                                    <button onclick="deleteStream('${stream.id}')" class="btn btn-danger btn-sm">
                                        <i class="fa fa-trash"></i> 删除
                                    </button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
                tbody.style.opacity = '1';
            }, 300);
        }

        // 添加流
        document.getElementById('addStreamForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const streamData = {
                name: document.getElementById('streamName').value,
                url: document.getElementById('streamUrl').value,
                customId: document.getElementById('streamCustomId').value,
                category: document.getElementById('streamCategory').value
            };

            try {
                const response = await fetch('/api/streams', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(streamData)
                });

                const result = await response.json();
                if (result.success) {
                    alert('流添加成功');
                    this.reset();
                    loadStreams();
                } else {
                    alert('添加流失败: ' + result.error);
                }
            } catch (error) {
                console.error('Error adding stream:', error);
                alert('添加流失败');
            }
        });

        // 删除流
        async function deleteStream(id) {
            if (!confirm('确定要删除这个流吗？')) {
                return;
            }

            try {
                const response = await fetch(`/api/streams/${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    loadStreams();
                } else {
                    alert('删除流失败: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting stream:', error);
                alert('删除流失败');
            }
        }

        // 重启流
        async function restartStream(id, manual = false) {
            try {
                const response = await fetch(`/api/streams/${id}/restart`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ manual })
                });
                const result = await response.json();
                if (result.success) {
                    alert('流已启动');
                    loadStreams();
                } else {
                    alert('重启流失败: ' + result.error);
                }
            } catch (error) {
                console.error('Error restarting stream:', error);
                alert('重启流失败');
            }
        }

        // 停止流
        async function stopStream(id) {
            try {
                const response = await fetch(`/api/streams/${id}/stop`, {
                    method: 'POST'
                });
                const result = await response.json();
                if (result.success) {
                    alert('流已停止');
                    loadStreams();
                } else {
                    alert('停止流失败: ' + result.error);
                }
            } catch (error) {
                console.error('Error stopping stream:', error);
                alert('停止流失败');
            }
        }

        // 修改导出配置函数
        function exportConfig() {
            fetch('/api/streams')
                .then(response => response.json())
                .then(streams => {
                    const config = streams.map(stream => {
                        const playUrl = `http://${serverConfig.server.host}:${serverConfig.server.port}/play/${stream.id}`;
                        return `#EXTINF:-1 tvg-id="${stream.tvg?.id || ''}" tvg-name="${stream.tvg?.name || ''}" tvg-logo="${stream.tvg?.logo || ''}" group-title="${stream.tvg?.group || ''}", ${stream.name}\n${stream.kodiprop || ''}\n${playUrl}`;
                    }).join('\n\n');
                    
                    const blob = new Blob([config], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'streams.m3u';
                    a.click();
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => {
                    console.error('Error exporting config:', error);
                    alert('导出配置失败');
                });
        }

        // 格式化运行时间
        function formatUptime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            const remainingHours = hours % 24;
            const remainingMinutes = minutes % 60;

            let result = '';
            if (days > 0) result += `${days}天`;
            if (remainingHours > 0) result += `${remainingHours}时`;
            if (remainingMinutes > 0) result += `${remainingMinutes}分`;
            if (result === '') result = '刚刚启动';

            return result;
        }

        // 刷新流列表
        function refreshStreams() {
            loadStreams();
        }

        // 初始加载
        async function init() {
            await getServerConfig();
            await loadServerConfig();
            await loadStreams();
            
            // 每5秒更新一次状态
            setInterval(loadStreams, 5000);  // 从10000改为5000
        }

        // 启动始化
        init();

        // 添加更新流ID函数
        async function updateStreamId(oldId, newId) {
            try {
                const response = await fetch(`/api/streams/${oldId}/updateId`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ newId: `stream_${newId}` })
                });

                const result = await response.json();
                if (result.success) {
                    loadStreams();
                } else {
                    alert('更新流ID失败: ' + result.error);
                }
            } catch (error) {
                console.error('Error updating stream ID:', error);
                alert('更新流ID失败');
            }
        }

        // 修��复制到剪贴板函数
        function copyToClipboard(text) {
            // 创建临时输入框
            const input = document.createElement('input');
            input.style.position = 'fixed';
            input.style.opacity = 0;
            input.value = text;
            document.body.appendChild(input);
            
            // 选择并复制
            input.select();
            input.setSelectionRange(0, 99999); // 用于动设备
            
            try {
                // 执行复制命令
                document.execCommand('copy');
                
                // 显示提示
                const toast = document.createElement('div');
                toast.className = 'alert alert-success position-fixed bottom-0 end-0 m-3';
                toast.style.zIndex = '9999';
                toast.textContent = '播放地址已复制';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
            } catch (err) {
                console.error('复制失败:', err);
                alert('复制失败');
            } finally {
                // 移除临时输入框
                document.body.removeChild(input);
            }
        }

        // 批量导入处
        document.getElementById('batchImportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const batchText = document.getElementById('batchStreams').value;
            const lines = batchText.split('\n').filter(line => line.trim());
            
            let currentCategory = '';
            let successCount = 0;
            let failCount = 0;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // 检查是否是分类行
                if (line.endsWith('#genre#')) {
                    currentCategory = line.split(',')[0].trim();
                    continue;
                }
                
                // 处理常规流行
                const [name, url] = line.split(',').map(s => s.trim());
                
                if (!name || !url) {
                    failCount++;
                    continue;
                }

                try {
                    const response = await fetch('/api/streams', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name,
                            url,
                            category: currentCategory
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                } catch (error) {
                    console.error('Error adding stream:', error);
                    failCount++;
                }
            }

            alert(`批量导入完成\n成功: ${successCount}\n失败: ${failCount}`);
            if (successCount > 0) {
                this.reset();
                loadStreams();
            }
        });

        // 修改 toggleSelectAll 函数
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const checkboxes = document.getElementsByClassName('stream-checkbox');
            
            // 使用 selectAllCheckbox.checked 来确定是否全选
            for (let box of checkboxes) {
                box.checked = selectAllCheckbox.checked;
            }
            
            // 更新批量操作按钮状态
            updateBatchButtons();
        }

        // 更新量操作按钮状态
        function updateBatchButtons() {
            const selectedCount = getSelectedStreams().length;
            const batchStopBtn = document.getElementById('batchStopBtn');
            const batchDeleteBtn = document.getElementById('batchDeleteBtn');
            const batchAutoStartOnBtn = document.getElementById('batchAutoStartOnBtn');
            const batchAutoStartOffBtn = document.getElementById('batchAutoStartOffBtn');

            batchStopBtn.disabled = selectedCount === 0;
            batchDeleteBtn.disabled = selectedCount === 0;
            batchAutoStartOnBtn.disabled = selectedCount === 0;
            batchAutoStartOffBtn.disabled = selectedCount === 0;
        }

        // ��取选中的流
        function getSelectedStreams() {
            const checkboxes = document.getElementsByClassName('stream-checkbox');
            return Array.from(checkboxes)
                .filter(box => box.checked)
                .map(box => box.value);
        }

        // 修改批量手动启动函数
        async function batchManualStart() {
            const selectedStreams = getSelectedStreams();
            if (!selectedStreams.length) return;
            
            if (!confirm(`确定要手动启动选中的 ${selectedStreams.length} 个流吗？这些流��会推流到远程服务器。`)) return;

            // 显示进度提示
            const progressModal = document.createElement('div');
            progressModal.className = 'modal fade show';
            progressModal.style.display = 'block';
            progressModal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            progressModal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">批量启动进度,请不要刷新，等待程序运行完成</h5>
                        </div>
                        <div class="modal-body">
                            <div class="progress mb-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="small text-muted" id="progressDetail"></div>
                            <div class="mt-2" id="progressStats">
                                处理: 0/${selectedStreams.length}<br>
                                成功: <span class="text-success">0</span>
                                失败: <span class="text-danger">0</span>
                                跳过: <span class="text-warning">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(progressModal);

            const progressBar = progressModal.querySelector('.progress-bar');
            const progressDetail = progressModal.querySelector('#progressDetail');
            const progressStats = progressModal.querySelector('#progressStats');
            
            let success = 0;
            let failed = 0;
            let skipped = 0;
            const errors = [];
            const failedStreams = new Map(); // 记录失败的流及其重试次数

            // 更新进度显示的���数
            const updateProgress = (detail) => {
                const progress = ((success + failed + skipped) / selectedStreams.length * 100).toFixed(1);
                progressBar.style.width = `${progress}%`;
                progressDetail.textContent = detail;
                progressStats.innerHTML = `
                    处理中: ${success + failed + skipped}/${selectedStreams.length}<br>
                    成功: <span class="text-success">${success}</span>
                    失败: <span class="text-danger">${failed}</span>
                    跳过: <span class="text-warning">${skipped}</span>
                `;
            };

            // 尝试启动单个流的函数
            const startStream = async (streamId) => {
                try {
                    // 先检查流是否已经是手动启动状态
                    const streamStatus = await fetch(`/api/streams/${streamId}`).then(r => r.json());
                    if (streamStatus.manuallyStarted) {
                        skipped++;
                        updateProgress(`跳过已手动启动的流: ${streamId}`);
                        return true;
                    }
                    // 注意：不再检查 processRunning，因为我们要把普通运行的流转换为手动启动状态

                    // 设置单个流的超时
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 20000);

                    const response = await fetch(`/api/streams/${streamId}/restart`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ manual: true }),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    const result = await response.json();
                    if (result.success) {
                        success++;
                        updateProgress(`成功启动: ${streamId}`);
                        return true;
                    } else {
                        throw new Error(result.error || '未知错误');
                    }
                } catch (error) {
                    return false;
                }
            };

            // 第一轮: 尝试启动所有流
            const batchSize = 4;
            const batches = [];
            for (let i = 0; i < selectedStreams.length; i += batchSize) {
                batches.push(selectedStreams.slice(i, i + batchSize));
            }

            updateProgress('开始第一轮启动...');

            for (let i = 0; i < batches.length; i++) {
                const batch = batches[i];
                const results = await Promise.allSettled(
                    batch.map(async streamId => {
                        const success = await startStream(streamId);
                        if (!success) {
                            failedStreams.set(streamId, 0); // 初始化重试次数为0
                        }
                        return { streamId, success };
                    })
                );
                
                // 每批次之间暂停1.5秒
                if (i < batches.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }

            // 第二轮: 重试失败的流
            if (failedStreams.size > 0) {
                updateProgress('开始重试失败的流...');
                
                const maxRetries = 3;
                for (let retry = 0; retry < maxRetries; retry++) {
                    const currentFailedStreams = Array.from(failedStreams.keys());
                    if (currentFailedStreams.length === 0) break;

                    updateProgress(`第 ${retry + 1} 次重试...`);
                    
                    // 将失败的流分成小次
                    const retryBatches = [];
                    for (let i = 0; i < currentFailedStreams.length; i += batchSize) {
                        retryBatches.push(currentFailedStreams.slice(i, i + batchSize));
                    }

                    for (const batch of retryBatches) {
                        const results = await Promise.allSettled(
                            batch.map(async streamId => {
                                const success = await startStream(streamId);
                                if (success) {
                                    failedStreams.delete(streamId);
                                } else {
                                    const retryCount = failedStreams.get(streamId) + 1;
                                    if (retryCount >= maxRetries) {
                                        failed++;
                                        errors.push(`${streamId}: 重试${maxRetries}次后仍然失败`);
                                        failedStreams.delete(streamId);
                                    } else {
                                        failedStreams.set(streamId, retryCount);
                                    }
                                }
                                return { streamId, success };
                            })
                        );

                        // 批次间隔2秒
                        if (batch !== retryBatches[retryBatches.length - 1]) {
                            await new Promise(resolve => setTimeout(resolve, 2000));
                        }
                    }
                }
            }

            // 移除进度模态框
            progressModal.remove();

            // 显示最终结果
            const resultModal = document.createElement('div');
            resultModal.className = 'modal fade show';
            resultModal.style.display = 'block';
            resultModal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            resultModal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">批量启动结果</h5>
                            <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-4 text-center">
                                    <div class="h3 text-success">${success}</div>
                                    <div class="text-muted">成功</div>
                                </div>
                                <div class="col-4 text-center">
                                    <div class="h3 text-danger">${failed}</div>
                                    <div class="text-muted">失败</div>
                                </div>
                                <div class="col-4 text-center">
                                    <div class="h3 text-warning">${skipped}</div>
                                    <div class="text-muted">跳过</div>
                                </div>
                            </div>
                            ${errors.length > 0 ? `
                                <div class="mt-3">
                                    <h6>错误详情:</h6>
                                    <pre class="small bg-light p-2" style="max-height: 200px; overflow-y: auto;">
                                        ${errors.join('\n')}
                                    </pre>
                                </div>
                            ` : ''}
                            ${success > 0 ? `
                                <div class="alert alert-success mt-3">
                                    成功启动的流已开始推流到远程服务器
                                </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="this.closest('.modal').remove()">确定</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(resultModal);

            // 刷新流列表
            loadStreams();
        }

        // 修改批量停止函数
        async function batchStop() {
            const selectedStreams = getSelectedStreams();
            if (!selectedStreams.length) return;
            
            if (!confirm(`确定要停止选中的 ${selectedStreams.length} 个流吗？这将同时停止HLS推流和远程推流`)) return;

            // 显示进度提示
            const progressModal = document.createElement('div');
            progressModal.className = 'modal fade show';
            progressModal.style.display = 'block';
            progressModal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            progressModal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">批量停止进度</h5>
                        </div>
                        <div class="modal-body">
                            <div class="progress mb-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="small text-muted" id="stopProgressDetail"></div>
                            <div class="mt-2" id="stopProgressStats">
                                处理中: 0/${selectedStreams.length}<br>
                                成功: <span class="text-success">0</span>
                                失败: <span class="text-danger">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(progressModal);

            const progressBar = progressModal.querySelector('.progress-bar');
            const progressDetail = progressModal.querySelector('#stopProgressDetail');
            const progressStats = progressModal.querySelector('#stopProgressStats');

            let success = 0;
            let failed = 0;
            const errors = [];
            
            // 每批10个流同时处理
            const batchSize = 10;
            const batches = [];
            for (let i = 0; i < selectedStreams.length; i += batchSize) {
                batches.push(selectedStreams.slice(i, i + batchSize));
            }

            for (let i = 0; i < batches.length; i++) {
                const batch = batches[i];
                const batchPromises = batch.map(async streamId => {
                    try {
                        // 更新进度显示
                        const progress = ((success + failed) / selectedStreams.length * 100).toFixed(1);
                        progressBar.style.width = `${progress}%`;
                        progressDetail.textContent = `正在处理: ${streamId}`;
                        progressStats.innerHTML = `
                            处理中: ${success + failed}/${selectedStreams.length}<br>
                            ��功: <span class="text-success">${success}</span>
                            失败: <span class="text-danger">${failed}</span>
                        `;

                        // 设置超时
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10秒超时

                        const response = await fetch(`/api/streams/${streamId}/stop`, {
                            method: 'POST',
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (response.ok) {
                            success++;
                        } else {
                            const error = await response.text();
                            throw new Error(error);
                        }
                    } catch (error) {
                        failed++;
                        errors.push(`${streamId}: ${error.message}`);
                        console.error(`Error stopping stream ${streamId}:`, error);
                    }
                });

                // 等待当前批次完成
                await Promise.allSettled(batchPromises);

                // 批次间隔1秒
                if (i < batches.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            // 移除进度模态框
            progressModal.remove();
            
            // 显示结果
            const resultModal = document.createElement('div');
            resultModal.className = 'modal fade show';
            resultModal.style.display = 'block';
            resultModal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            resultModal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">批量停止结��</h5>
                            <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-6 text-center">
                                    <div class="h3 text-success">${success}</div>
                                    <div class="text-muted">成功</div>
                                </div>
                                <div class="col-6 text-center">
                                    <div class="h3 text-danger">${failed}</div>
                                    <div class="text-muted">失败</div>
                                </div>
                            </div>
                            ${errors.length > 0 ? `
                                <div class="mt-3">
                                    <h6>错误详情:</h6>
                                    <pre class="small bg-light p-2" style="max-height: 200px; overflow-y: auto;">
                                        ${errors.join('\n')}
                                    </pre>
                                </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="this.closest('.modal').remove()">确定</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(resultModal);
            
            // 刷新流列表
            loadStreams();
        }

        // 批量删除
        async function batchDelete() {
            const selectedStreams = getSelectedStreams();
            if (!selectedStreams.length) return;
            
            if (!confirm(`确定要删除选中的 ${selectedStreams.length} 个流吗？此操作不可恢复！`)) return;

            let success = 0;
            let failed = 0;
            
            for (const streamId of selectedStreams) {
                try {
                    const response = await fetch(`/api/streams/${streamId}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    if (result.success) {
                        success++;
                    } else {
                        failed++;
                    }
                } catch (error) {
                    console.error(`Error deleting stream ${streamId}:`, error);
                    failed++;
                }
            }
            
            alert(`批量删除完成\n成功: ${success}\n失败: ${failed}`);
            loadStreams();
        }

        // 打开编辑态框
        async function editStream(streamId) {
            try {
                const response = await fetch(`/api/streams/${streamId}`);
                const stream = await response.json();
                
                // 填充表单
                document.getElementById('editStreamId').value = streamId;
                document.getElementById('editStreamCategory').value = stream.category || '';
                document.getElementById('editStreamName').value = stream.name;
                document.getElementById('editStreamUrl').value = stream.url;
                
                // 显示模态框
                const modal = new bootstrap.Modal(document.getElementById('editStreamModal'));
                modal.show();
            } catch (error) {
                console.error('Error loading stream details:', error);
                alert('加载息失败');
            }
        }

        // 保存编辑
        async function saveStreamEdit() {
            const streamId = document.getElementById('editStreamId').value;
            const streamData = {
                category: document.getElementById('editStreamCategory').value,
                name: document.getElementById('editStreamName').value,
                url: document.getElementById('editStreamUrl').value
            };

            try {
                // 先停止流
                await stopStream(streamId);
                
                // 然后更新配置
                const response = await fetch(`/api/streams/${streamId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(streamData)
                });

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error);
                }

                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('editStreamModal'));
                modal.hide();
                
                // 刷新流列表
                loadStreams();
                alert('更新成功');
            } catch (error) {
                console.error('Error updating stream:', error);
                alert('更新失败: ' + error.message);
            }
        }

        // 添加复制推流信息的函
        function copyRtmpInfo(streamId) {
            const rtmpInfo = `推流地址：rtmp://ali.push.yximgs.com/live/${streamId}\n` +
                            `播放地址：http://ali.hlspull.yximgs.com/live/${streamId}.flv`;
            
            // 创建文本框并复制
            const textarea = document.createElement('textarea');
            textarea.value = rtmpInfo;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            
            // 显示提示
            const toast = document.createElement('div');
            toast.className = 'alert alert-success position-fixed bottom-0 end-0 m-3';
            toast.style.zIndex = '9999';
            toast.textContent = '推流信息已复制到剪贴板';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // 添加工具面板换功能
        function toggleTools() {
            const content = document.getElementById('toolsContent');
            content.classList.toggle('show');
            const chevron = document.querySelector('.tools-toggle .fa-chevron-down');
            chevron.style.transform = content.classList.contains('show') ? 'rotate(180deg)' : 'rotate(0)';
        }

        // 添加刷新页面的函数
        function refreshPage() {
            // 添加旋转动画效果
            const refreshBtn = document.querySelector('button[onclick="refreshPage()"] i');
            refreshBtn.style.transition = 'transform 0.5s';
            refreshBtn.style.transform = 'rotate(360deg)';
            
            // 刷新页面
            window.location.reload();
        }

        // 修改加载服务器配置函数
        async function loadServerConfig() {
            try {
                const response = await fetch('/api/config');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const config = await response.json();
                
                // 更新版本号显示
                document.getElementById('systemVersion').textContent = config.version || '未知';
                
                // 只更新服务器地址和端口
                document.getElementById('serverHost').value = config.server?.host || '';
                document.getElementById('serverPort').value = config.server?.port || '';
            } catch (error) {
                console.error('Error loading server config:', error);
                const errorMessage = error.message.includes('Failed to fetch') 
                    ? '无法连接到服务器，请检查网络连接'
                    : '加载服务器配置失败: ' + error.message;
                alert(errorMessage);
            }
        }

        // 修改保存服务器配置函数
        document.getElementById('serverConfigForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                // 先获取当前配置
                const configResponse = await fetch('/api/config');
                const currentConfig = await configResponse.json();
                
                // 创建新的配置对象，保留原有配置，只更新服务器地址和端口
                const newConfig = {
                    ...currentConfig,  // 保留所有现有配置
                    server: {
                        ...currentConfig.server,  // 保留服务器配置中的其他字段
                        host: document.getElementById('serverHost').value,
                        port: parseInt(document.getElementById('serverPort').value)
                    }
                };

                // 发送更新后的完整配置
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newConfig)
                });

                const result = await response.json();
                if (result.success) {
                    if (result.requireRestart) {
                        // 显示重启倒计时模态框
                        const modal = document.createElement('div');
                        modal.className = 'modal fade show';
                        modal.style.display = 'block';
                        modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                        modal.innerHTML = `
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">系统重启</h5>
                                    </div>
                                    <div class="modal-body">
                                        <p>配置已保存，系统将在 <span id="restartCountdown">5</span> 秒后重启...</p>
                                        <div class="progress">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                 role="progressbar" 
                                                 style="width: 100%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(modal);

                        // 倒计时
                        let countdown = 5;
                        const countdownEl = document.getElementById('restartCountdown');
                        const timer = setInterval(() => {
                            countdown--;
                            countdownEl.textContent = countdown;
                            if (countdown <= 0) {
                                clearInterval(timer);
                                // 显示重连的提示
                                modal.querySelector('.modal-body').innerHTML = `
                                    <p>系统正在重启，请稍候...</p>
                                    <div class="d-flex justify-content-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                `;
                                // 等待服务器重启完成
                                setTimeout(() => {
                                    checkServerAndReload();
                                }, 2000);
                            }
                        }, 1000);
                    } else {
                        alert(result.message || '配置保存成功');
                    }
                } else {
                    alert('保存配置失败: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving server config:', error);
                alert('保存配置失败: ' + (error.message || '未知错误'));
            }
        });

        // 添加检查服务器状态并重载的函数
        async function checkServerAndReload() {
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    window.location.reload();
                } else {
                    // 如果服务器还没准备好，继续尝试
                    setTimeout(checkServerAndReload, 1000);
                }
            } catch (error) {
                // 如果连接失败，继续尝试
                setTimeout(checkServerAndReload, 1000);
            }
        }

        // 显示修改密码模态框
        function showChangePasswordModal() {
            const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
            modal.show();
        }

        // 修改密码
        async function changePassword() {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!oldPassword || !newPassword || !confirmPassword) {
                alert('所有密码字段都必须填写');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('两次输入的新密码不一致');
                return;
            }

            try {
                const response = await fetch('/api/change-password', {  // 修改API路径
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ oldPassword, newPassword })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
                    modal.hide();
                    // 清空表单
                    document.getElementById('changePasswordForm').reset();
                    // 登出
                    logout();
                } else {
                    alert(result.message || '修改密码失败');
                }
            } catch (error) {
                console.error('Change password error:', error);
                alert('修改密码失败，请检查网络连接');
            }
        }

        // 登出
        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/login.html';  // 修改这里的重定向路径
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        async function updateAutoConfig(streamId, type, value) {
            try {
                const response = await fetch(`/api/streams/${streamId}/auto-config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        [type]: value
                    })
                });
                
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error);
                }
                
                loadStreams(); // 刷新列表
            } catch (error) {
                console.error('Error updating auto config:', error);
                alert('更新自动配置失败: ' + error.message);
            }
        }

        async function batchAutoConfig(type, value) {
            const selectedStreams = getSelectedStreams();
            if (!selectedStreams.length) {
                alert('请先选择要操作的流');
                return;
            }
            
            // 显示进度模态框
            const modal = showProgressModal('批量设置自动配置');
            
            try {
                const response = await fetch('/api/streams/batch-auto-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        streamIds: selectedStreams,
                        [type]: value
                    })
                });
                
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error);
                }
                
                // 更新进度显示
                updateProgressModal(modal, {
                    success: result.stats.success,
                    retrying: result.stats.retrying,
                    total: result.stats.total
                });
                
                // 3秒后关闭进度模态框
                setTimeout(() => {
                    modal.remove();
                    loadStreams(); // 刷新列表
                }, 3000);
                
            } catch (error) {
                console.error('Error in batch auto config:', error);
                alert('批量设置失败: ' + error.message);
                modal.remove();
            }
        }

        // 显示进度模态框的函数
        function showProgressModal(title) {
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${title}</h5>
                        </div>
                        <div class="modal-body">
                            <div class="progress mb-3">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div id="progressStats"></div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            return modal;
        }

        // 更新进度模态框的函数
        function updateProgressModal(modal, stats) {
            const { success, failed, total, current } = stats;
            const progress = ((current || success) / total * 100).toFixed(1);
            
            const progressBar = modal.querySelector('.progress-bar');
            progressBar.style.width = `${progress}%`;
            progressBar.style.backgroundColor = success > 0 ? '#28a745' : '#dc3545';
            
            const statsDiv = modal.querySelector('#progressStats');
            statsDiv.innerHTML = `
                <div class="text-center">
                    <div class="h5 mb-2">处理进度: ${current || (success + (failed || 0))}/${total}</div>
                    <div class="text-success">成功: ${success}</div>
                    ${failed ? `<div class="text-danger">失败: ${failed}</div>` : ''}
                    ${current < total ? '<div class="text-info mt-2">正在处理中...</div>' : 
                                      '<div class="text-success mt-2">处理完成!</div>'}
                </div>
            `;
        }

        // 添加推流功能
        async function startRtmpPush(streamId) {
            try {
                const response = await fetch(`/api/streams/${streamId}/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ rtmpPush: true })
                });
                
                // 检查响应类型
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // 如果不是 JSON 响应，可能是会话过期
                    if (response.status === 401) {
                        alert('会话已过期，请重新登录');
                        window.location.href = '/login.html';
                        return;
                    }
                    throw new Error('服务器返回了非预期的响应类型');
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || '启动推流失败');
                }
                
                loadStreams(); // 刷新列表
            } catch (error) {
                console.error('Error starting RTMP push:', error);
                if (error.message.includes('<!DOCTYPE')) {
                    alert('会话已过期，请重新登录');
                    window.location.href = '/login.html';
                } else {
                    alert('启动推流失败: ' + error.message);
                }
            }
        }

        // 修改自启动切换函数
        async function toggleAutoStart(streamId, enable) {
            try {
                // 显示加载提示
                const button = document.querySelector(`button[onclick="toggleAutoStart('${streamId}', ${!enable})"]`);
                if (button) {
                    const originalHtml = button.innerHTML;
                    button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 处理中...';
                    button.disabled = true;
                }

                // 设置自动启动状态
                const response = await fetch(`/api/streams/${streamId}/auto-start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ autoStart: enable })
                });

                if (!response.ok) {
                    throw new Error('请求失败: ' + response.status);
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || '设置自动启动失败');
                }

                // 刷新列表以更新状态
                await loadStreams();

                // 显示成功提示
                const toast = document.createElement('div');
                toast.className = 'alert alert-success position-fixed bottom-0 end-0 m-3';
                toast.style.zIndex = '9999';
                toast.textContent = enable ? '已开启自动启动' : '已关闭自动启动';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);

            } catch (error) {
                console.error('Error toggling auto-start:', error);
                alert('设置自动启动失败: ' + error.message);
            } finally {
                // 恢复按钮状态
                const button = document.querySelector(`button[onclick="toggleAutoStart('${streamId}', ${!enable})"]`);
                if (button) {
                    button.innerHTML = `
                        <i class="fa ${enable ? 'fa-moon-o' : 'fa-sun-o'}"></i> 
                        ${enable ? '自启关' : '自启开'}
                    `;
                    button.disabled = false;
                }
            }
        }

        // 修改批量设置自启动函数
        async function batchAutoStart(enable) {
            const selectedStreams = getSelectedStreams();
            if (!selectedStreams.length) {
                alert('请先选择要操作的流');
                return;
            }

            // 显示进度模态框
            const modal = showProgressModal(`批量${enable ? '开启' : '关闭'}自动启动`);
            
            try {
                const response = await fetch('/api/streams/batch-auto-start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        streamIds: selectedStreams,
                        autoStart: enable
                    })
                });

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error);
                }

                // 更新进度显示
                updateProgressModal(modal, {
                    success: result.stats.success,
                    total: result.stats.total,
                    current: result.stats.total
                });

                // 3秒后关闭进度模态框
                setTimeout(() => {
                    modal.remove();
                    loadStreams(); // 刷新列表
                }, 3000);

            } catch (error) {
                console.error('Error in batch auto-start:', error);
                alert('批量设置失败: ' + error.message);
                modal.remove();
            }
        }

        // 修改进度模态框显示函数
        function showProgressModal(title) {
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${title}</h5>
                        </div>
                        <div class="modal-body">
                            <div class="progress mb-3" style="height: 20px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%"></div>
                            </div>
                            <div id="progressStats" class="text-center">
                                <div class="text-info">准备处理...</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            return modal;
        }

        // 添加重启服务器函数
        async function restartServer() {
            if (!confirm('确定要重启服务器吗？这将会中断所有正在运行的流。')) {
                return;
            }

            try {
                // 显示加载提示
                const button = document.querySelector('button[onclick="restartServer()"]');
                const originalHtml = button.innerHTML;
                button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 重启中...';
                button.disabled = true;

                const response = await fetch('/api/server/restart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('重启请求失败');
                }

                // 显示重启倒计时提示
                const modal = document.createElement('div');
                modal.className = 'modal fade show';
                modal.style.display = 'block';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modal.innerHTML = `
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">服务器重启中</h5>
                            </div>
                            <div class="modal-body text-center">
                                <div class="mb-3">
                                    <i class="fa fa-refresh fa-spin fa-3x"></i>
                                </div>
                                <p>服务器正在重启，请等待 <span id="restartCountdown">30</span> 秒...</p>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // 开始倒计时
                let countdown = 30;
                const progressBar = modal.querySelector('.progress-bar');
                const countdownSpan = modal.querySelector('#restartCountdown');
                
                const timer = setInterval(() => {
                    countdown--;
                    countdownSpan.textContent = countdown;
                    progressBar.style.width = `${((30 - countdown) / 30) * 100}%`;
                    
                    if (countdown <= 0) {
                        clearInterval(timer);
                        window.location.reload();
                    }
                }, 1000);

            } catch (error) {
                console.error('Error restarting server:', error);
                alert('重启服务器失败: ' + error.message);
                
                // 恢复按钮状态
                const button = document.querySelector('button[onclick="restartServer()"]');
                button.innerHTML = '<i class="fa fa-refresh"></i> 重启服务器';
                button.disabled = false;
            }
        }

        // 修改更新统计信息的函数
        async function updateSystemStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                // 更新统计显示
                document.getElementById('totalStreams').textContent = stats.totalStreams;
                document.getElementById('activeStreams').textContent = stats.activeStreams;
                document.getElementById('systemUptime').textContent = stats.uptime;
                document.getElementById('trafficReceived').textContent = stats.traffic.received;
                document.getElementById('trafficSent').textContent = stats.traffic.sent;
            } catch (error) {
                console.error('Error updating system stats:', error);
            }
        }

        // 在页面加载完成后启动定时更新
        document.addEventListener('DOMContentLoaded', () => {
            // 立即更新一次
            updateSystemStats();
            
            // 每5秒更新一次
            setInterval(updateSystemStats, 5000);
        });
    </script>

    <!-- 在 body 标签束前添加编辑模态框 -->
    <div class="modal fade" id="editStreamModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑流</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editStreamForm">
                        <input type="hidden" id="editStreamId">
                        <div class="mb-3">
                            <label class="form-label">分类</label>
                            <input type="text" class="form-control" id="editStreamCategory">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">名称</label>
                            <input type="text" class="form-control" id="editStreamName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">源址</label>
                            <input type="text" class="form-control" id="editStreamUrl" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveStreamEdit()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 在body末尾添加修改密码模态框 -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">���改密���</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label class="form-label">旧密码</label>
                            <input type="password" class="form-control" id="oldPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">新密码</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">确认新密码</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="changePassword()">保存</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 